<!DOCTYPE HTML>
<html><head><meta charset="UTF-8"><style type="text/css">/* Copyright 2019 Google LLC                              */
/*                                                        */
/* Use of this source code is governed by a BSD-style     */
/* license that can be found in the LICENSE file or at    */
/* https://developers.google.com/open-source/licenses/bsd */

body {
  font-family: Helvetica, sans-serif;
  font-size: 100%;
  color: #333;
  display: flex;
  justify-content: space-between;
  overflow-x: hidden;

  --main-width: 50rem;
  --nav-width: 20rem;
}

@media (max-width: 70rem) {
    /*For narrow screens hide nav and enable horizontal scrolling */
    nav {display: none;}
    body {overflow-x: auto;}
}

nav {/* this actually just holds space for #navbar, which is fixed */
  min-width: var(--nav-width);
  max-width: var(--nav-width);
}
#navbar {
  position: fixed;
  height: 100vh;
  width: var(--nav-width);
  overflow-y: scroll;
  border-right: 1px solid firebrick;
}
#navbar:before {
  content: "Contents";
  font-weight: bold;
}
nav ol {
  list-style-type:none;
  padding-left: 1rem;
}

#main-output {
  max-width: var(--main-width);
  margin: auto;
}

.cell {
}

.code-block, .err-block, .result-block {
  padding: 0em 0em 0em 2em;
  display: block;
  font-family: monospace;
  white-space: pre;
}

code {
  background-color: #F0F0F0;
}

.result-block {
  border-left: 3px solid  #87CEFA;
}

.prose-block {
  line-height: 140%;
}

.err-block {
  font-weight: bold;
  color: #B22222;
  border-left: 3px solid #B22222;
}

.plot {
  padding: 5em;
}

.plot-img {
  width: 80%;
}

.comment {
  color: #808080;
}

.keyword {
  color: #0000DD;
}

.command {
  color: #A80000;
}

.symbol {
  color: #E07000;
}

.type-name {
  color: #A80000;
}

.iso-sugar {
  color: #25BBA7;
}
</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" onload="// Copyright 2019 Google LLC
//
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file or at
// https://developers.google.com/open-source/licenses/bsd

var katexOptions = {
    delimiters: [
        {left: &quot;$$&quot;, right: &quot;$$&quot;, display: true},
        {left: &quot;\\[&quot;, right: &quot;\\]&quot;, display: true},
        {left: &quot;$&quot;, right: &quot;$&quot;, display: false},
        {left: &quot;\\(&quot;, right: &quot;\\)&quot;, display: false}
    ],
    // Enable commands that load resources or change HTML attributes
    // (e.g. hyperlinks): https://katex.org/docs/security.html.
    trust: true
};

var cells = {};

function append_contents(key, contents) {
    if (key in cells) {
        var cur_cells = cells[key];
    } else {
        var cell = document.createElement(&quot;div&quot;);
        cell.className = &quot;cell&quot;;
        cells[key] = [cell];
        var cur_cells = [cell];
    }
    for (var i = 0; i &lt; contents.length; i++) {
        for (var j = 0; j &lt; cur_cells.length; j++) {
            var node = lookup_address(cur_cells[j], contents[i][0])
            node.innerHTML += contents[i][1];
        }
    }
}

function lookup_address(cell, address) {
    var node = cell
    for (i = 0; i &lt; address.length; i++) {
        node = node.children[address[i]]
    }
    return node
}

function renderLaTeX() {
    // Render LaTeX equations in prose blocks via KaTeX, if available.
    // Skip rendering if KaTeX is unavailable.
    if (typeof renderMathInElement == &#39;undefined&#39;) {
        return;
    }
    // Render LaTeX equations in prose blocks via KaTeX.
    var proseBlocks = document.querySelectorAll(&quot;.prose-block&quot;);
    Array.from(proseBlocks).map((proseBlock) =&gt;
        renderMathInElement(proseBlock, katexOptions)
    );
}

/**
 * Rendering the Table of Contents / Navigation Bar
 * 2 key functions
 *  - `updateNavigation()` which inserts/updates the navigation bar
 *  - and it&#39;s helper `extractStructure()` which extracts the structure of the page
 *    and adds ids to heading elements.
*/
function updateNavigation() {
    function navItemList(struct) {
        var listEle = document.createElement(&#39;ol&#39;)
        struct.children.forEach(childStruct=&gt;
            listEle.appendChild(navItem(childStruct))
        );
        return listEle;
    }
    function navItem(struct) {
        var a = document.createElement(&#39;a&#39;);
        a.appendChild(document.createTextNode(struct.text));
        a.title = struct.text;
        a.href = &quot;#&quot;+struct.id;

        var ele = document.createElement(&#39;li&#39;)
        ele.appendChild(a)
        ele.appendChild(navItemList(struct));
        return ele;
    }

    var navbarEle = document.getElementById(&quot;navbar&quot;)
    if (navbarEle === null) {  // create it
        navbarEle = document.createElement(&quot;div&quot;);
        navbarEle.id=&quot;navbar&quot;;
        navOuterEle = document.createElement(&quot;nav&quot;)
        navOuterEle.appendChild(navbarEle);
        document.body.prepend(navOuterEle);
    }

    navbarEle.innerHTML = &quot;&quot;
    var structure = extractStructure()
    navbarEle.appendChild(navItemList(structure));
}

function extractStructure() { // Also sets ids on h1,h2,...
    var headingsNodes = document.querySelectorAll(&quot;h1, h2, h3, h4, h5, h6&quot;);
    // For now we are just fulling going to regenerate the structure each time
    // Might be better if we made minimal changes, but ðŸ¤·

    // Extract the structure of the document
    var structure = {children:[]}
    var active = [structure.children];
    headingsNodes.forEach(
        function(currentValue, currentIndex) {
            currentValue.id = &quot;s-&quot; + currentIndex;
            var currentLevel = parseInt(currentValue.nodeName[1]);

            // Insert dummy levels up for any levels that are skipped
            for (var i=active.length; i &lt; currentLevel; i++) {
                var dummy = {id: &quot;&quot;, text: &quot;&quot;, children: []}
                active.push(dummy.children);
                var parentList = active[i-1]
                parentList.push(dummy);
            }
            // delete this level and everything after
            active.splice(currentLevel, active.length);

            var currentStructure = {
                id: currentValue.id,
                text: currentValue.textContent,
                children: [],
            };
            active.push(currentStructure.children);

            var parentList = active[active.length-2]
            parentList.push(currentStructure);
        },
    );
    return structure;
}

/**
 * HTML rendering mode.
 * Static rendering is used for static HTML pages.
 * Dynamic rendering is used for dynamic HTML pages via `dex web`.
 *
 * @enum {string}
 */
var RENDER_MODE = Object.freeze({
  STATIC: &quot;static&quot;,
  DYNAMIC: &quot;dynamic&quot;,
})

/**
 * Renders the webpage.
 * @param {RENDER_MODE} renderMode The render mode, either static or dynamic.
 */
function render(renderMode) {
    if (renderMode == RENDER_MODE.STATIC) {
        // For static pages, simply call rendering functions once.
        renderLaTeX();
        updateNavigation();
    } else {
        // For dynamic pages (via `dex web`), listen to update events.
        var source = new EventSource(&quot;/getnext&quot;);
        source.onmessage = function(event) {
            var body = document.getElementById(&quot;main-output&quot;);
            var msg = JSON.parse(event.data);
            if (msg == &quot;start&quot;) {
                body.innerHTML = &quot;&quot;;
                cells = {}
                return
            }
            var order    = msg[0];
            var contents = msg[1];
            for (var i = 0; i &lt; contents.length; i++) {
                append_contents(contents[i][0], contents[i][1]);
            }
            if (order != null) {
                var new_cells = {};
                body.innerHTML = &quot;&quot;;
                for (var i = 0; i &lt; order.val.length; i++) {
                    var key = order.val[i]
                    var cur_cells = cells[key]
                    if (cur_cells.length == 0) {
                        var cur_cell = new_cells[key][0].cloneNode(true)
                    } else {
                        var cur_cell = cur_cells.pop()
                        if (key in new_cells) {
                            new_cells[key].push(cur_cell);
                        } else {
                            new_cells[key] = [cur_cell];
                        }
                    }
                    body.appendChild(cur_cell);
                }
                Object.assign(cells, new_cells);
            }
            renderLaTeX();
            updateNavigation();
        };
    }
}
render(RENDER_MODE.STATIC);"></script></head><body><div id="main-output"><div class="cell"><div class="code-block"></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h1>Dex prelude</h1>
</div></div><div class="cell"><div class="prose-block"><p>Runs before every Dex program unless an alternative is provided with <code>--prelude</code>.</p>
</div></div><div class="cell"><div class="prose-block"><h2>Essentials</h2>
<h3>Primitive Types</h3>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Unit</span> <span class="symbol">=</span> %<span class="type-name">UnitType</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">TyKind</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Effects</span> <span class="symbol">=</span> %<span class="type-name">EffKind</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Fields</span> <span class="symbol">=</span> %<span class="type-name">LabeledRowKind</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int64</span> <span class="symbol">=</span> %<span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int32</span> <span class="symbol">=</span> %<span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float64</span> <span class="symbol">=</span> %<span class="type-name">Float64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float32</span> <span class="symbol">=</span> %<span class="type-name">Float32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word8</span>  <span class="symbol">=</span> %<span class="type-name">Word8</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word32</span> <span class="symbol">=</span> %<span class="type-name">Word32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word64</span> <span class="symbol">=</span> %<span class="type-name">Word64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Byte</span> <span class="symbol">=</span> <span class="type-name">Word8</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Char</span> <span class="symbol">=</span> <span class="type-name">Byte</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Label</span> <span class="symbol">=</span> %<span class="type-name">Label</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">RawPtr</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Word8Ptr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int</span> <span class="symbol">=</span> <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">Float32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Casting</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> internal_cast {a} (b<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> b <span class="symbol">=</span> %cast b x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f64_to_f (x <span class="symbol">:</span> <span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f32_to_f (x <span class="symbol">:</span> <span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_f64 (x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_f32 (x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i64_to_i (x <span class="symbol">:</span> <span class="type-name">Int64</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i32_to_i (x <span class="symbol">:</span> <span class="type-name">Int32</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w8_to_i  (x <span class="symbol">:</span> <span class="type-name">Word8</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_i64 (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_i32 (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_w8  (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_w32 (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Word32</span>  <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_w64 (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w32_to_w64 (x <span class="symbol">:</span> <span class="type-name">Word32</span>)<span class="symbol">:</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_f (x<span class="symbol">:</span><span class="type-name">Int</span>)   <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_i (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Int</span>   <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> raw_ptr_to_i64 (x<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">:</span> <span class="type-name">Int64</span>  <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Nat</span> <span class="symbol">=</span> %<span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">NatRep</span> <span class="symbol">=</span> <span class="type-name">Word32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> nat_to_rep (x <span class="symbol">:</span> <span class="type-name">Nat</span>)    <span class="symbol">:</span> <span class="type-name">NatRep</span> <span class="symbol">=</span> %projNewtype x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rep_to_nat (x <span class="symbol">:</span> <span class="type-name">NatRep</span>) <span class="symbol">:</span> <span class="type-name">Nat</span>    <span class="symbol">=</span> %newtype <span class="type-name">Nat</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_w8  (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_w32 (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Word32</span>  <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_w64 (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_i32 (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_i64 (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_f32 (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_f64 (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_f   (x <span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w8_to_n  (x <span class="symbol">:</span> <span class="type-name">Word8</span>)   <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w32_to_n (x <span class="symbol">:</span> <span class="type-name">Word32</span>)  <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w64_to_n (x <span class="symbol">:</span> <span class="type-name">Word64</span>)  <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i32_to_n (x <span class="symbol">:</span> <span class="type-name">Int32</span>)   <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i64_to_n (x <span class="symbol">:</span> <span class="type-name">Int64</span>)   <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f32_to_n (x <span class="symbol">:</span> <span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f64_to_n (x <span class="symbol">:</span> <span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_n   (x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">FromUnsignedInteger</span> a
  from_unsigned_integer <span class="symbol">:</span> <span class="type-name">Word64</span> <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Word8</span>
  from_unsigned_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Word32</span>
  from_unsigned_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Word64</span>
  from_unsigned_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Int32</span>
  from_unsigned_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Int64</span>
  from_unsigned_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Float32</span>
  from_unsigned_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Float64</span>
  from_unsigned_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span> <span class="type-name">Nat</span>
  from_unsigned_integer <span class="symbol">=</span> w64_to_n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">FromInteger</span> a
  from_integer <span class="symbol">:</span> <span class="type-name">Int64</span> <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span> <span class="type-name">Float32</span>
  from_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span> <span class="type-name">Int32</span>
  from_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span> <span class="type-name">Float64</span>
  from_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span> <span class="type-name">Int64</span>
  from_integer <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Bitwise operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Bits</span> a
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">Int</span> <span class="symbol">-&gt;</span> a
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">Int</span> <span class="symbol">-&gt;</span> a
  (<span class="symbol">.|.</span>)   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  (<span class="symbol">.^.</span>)   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span> <span class="type-name">Word8</span>
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shl x (i_to_w8 y)
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shr x (i_to_w8 y)
  (<span class="symbol">.|.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %or x y
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %and x y
  (<span class="symbol">.^.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %xor x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span> <span class="type-name">Word32</span>
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shl x (i_to_w32 y)
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shr x (i_to_w32 y)
  (<span class="symbol">.|.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %or x y
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %and x y
  (<span class="symbol">.^.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %xor x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span> <span class="type-name">Word64</span>
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shl x (i_to_w64 y)
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shr x (i_to_w64 y)
  (<span class="symbol">.|.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %or x y
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %and x y
  (<span class="symbol">.^.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %xor x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> low_word  (x <span class="symbol">:</span> <span class="type-name">Word64</span>) <span class="symbol">:</span> <span class="type-name">Word32</span> <span class="symbol">=</span> internal_cast _ (x <span class="symbol">.&gt;&gt;.</span> 32)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> high_word (x <span class="symbol">:</span> <span class="type-name">Word64</span>) <span class="symbol">:</span> <span class="type-name">Word32</span> <span class="symbol">=</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Basic Arithmetic</h3>
<h4>Add</h4>
<p>Things that can be added.
This defines the <code>Add</code> <a href="https://en.wikipedia.org/wiki/Group_(mathematics)">group</a> and its operators.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Add</span> a
  add <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  zero <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> [<span class="type-name">Add</span> a] <span class="type-name">Sub</span> a
  sub <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+</span>) {a} [<span class="type-name">Add</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> add
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">-</span>) {a} [<span class="type-name">Sub</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> sub
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Float64</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fadd x y
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Float64</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fsub x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Float32</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fadd x y
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Float32</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fsub x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Int64</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Int64</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Int32</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Int32</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Word8</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Word8</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Word32</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Word32</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Word64</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Word64</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Nat</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> rep_to_nat <span class="symbol">$</span> %iadd (nat_to_rep x) (nat_to_rep y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Unit</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  zero <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> <span class="type-name">Unit</span>
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> (n<span class="symbol">-&gt;</span>a) <span class="keyword">given</span> {n a} [<span class="type-name">Add</span> a]
  add <span class="symbol">=</span> <span class="symbol">\</span>f g<span class="symbol">.</span> <span class="symbol">\</span>x<span class="symbol">.</span> (f x) <span class="symbol">+</span> (g x)
  zero <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> (n<span class="symbol">-&gt;</span>a) <span class="keyword">given</span> {n a} [<span class="type-name">Sub</span> a]
  sub <span class="symbol">=</span> <span class="symbol">\</span>f g<span class="symbol">.</span> <span class="symbol">\</span>x<span class="symbol">.</span> (f x) <span class="symbol">-</span> (g x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Mul</h4>
<p>Things that can be multiplied.
This defines the <code>Mul</code> <a href="https://en.wikipedia.org/wiki/Monoid">Monoid</a>, and its operator.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Mul</span> a
  mul <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  one <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">*</span>) {a} [<span class="type-name">Mul</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> mul
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Float64</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fmul x y
  one <span class="symbol">=</span> f_to_f64 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Float32</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fmul x y
  one <span class="symbol">=</span> f_to_f32 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Int64</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Int32</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Word8</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Word32</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Word64</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Nat</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> rep_to_nat <span class="symbol">$</span> %imul (nat_to_rep x) (nat_to_rep y)
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Unit</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  one <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> (n<span class="symbol">-&gt;</span>a) <span class="keyword">given</span> {n a} [<span class="type-name">Mul</span> a]
  mul <span class="symbol">=</span> <span class="symbol">\</span>f g<span class="symbol">.</span> <span class="symbol">\</span>x<span class="symbol">.</span> (f x) <span class="symbol">*</span> (g x)
  one <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> one
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Integral</h4>
<p>Integer-like things.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Integral</span> a
  idiv <span class="symbol">:</span> a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a
  rem  <span class="symbol">:</span> a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Int64</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Int32</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Word8</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Word32</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Word64</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Nat</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> rep_to_nat <span class="symbol">$</span> %idiv (nat_to_rep x) (nat_to_rep y)
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> rep_to_nat <span class="symbol">$</span> %irem (nat_to_rep x) (nat_to_rep y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Fractional</h4>
<p>Rational-like things.
Includes floating point and two field rational representations.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Fractional</span> a
  divide <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Fractional</span> <span class="type-name">Float64</span>
  divide <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fdiv x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Fractional</span> <span class="type-name">Float32</span>
  divide <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fdiv x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Index set interface and instances</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Ix</span> n
  size n <span class="symbol">:</span> <span class="type-name">Nat</span>
  ordinal <span class="symbol">:</span> n <span class="symbol">-&gt;</span> <span class="type-name">Nat</span>
  unsafe_from_ordinal n <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">-&gt;</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Fin</span> (n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Fin</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- version of subtraction on Nats that clamps at zero
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">-|</span>) (x<span class="symbol">:</span> <span class="type-name">Nat</span>) (y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> nat_to_rep x
  y&#39; <span class="symbol">=</span> nat_to_rep y
  requires_clamp <span class="symbol">=</span> %ilt x&#39; y&#39;
  rep_to_nat <span class="symbol">$</span> %select requires_clamp 0 (%isub x&#39; y&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_nat_diff (x<span class="symbol">:</span><span class="type-name">Nat</span>) (y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> nat_to_rep x
  y&#39; <span class="symbol">=</span> nat_to_rep y
  rep_to_nat <span class="symbol">$</span> %isub x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(i..)` parses as `RangeFrom _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">RangeFrom</span> q<span class="symbol">:</span><span class="type-name">Type</span> i<span class="command">:q</span> <span class="symbol">=</span> <span class="type-name">UnsafeMkRangeFrom</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(i&lt;..)` parses as `RangeFromExc _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">RangeFromExc</span> q<span class="symbol">:</span><span class="type-name">Type</span> i<span class="command">:q</span> <span class="symbol">=</span> <span class="type-name">UnsafeMkRangeFromExc</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(..i)` parses as `RangeTo _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">RangeTo</span> q<span class="symbol">:</span><span class="type-name">Type</span> i<span class="command">:q</span> <span class="symbol">=</span> <span class="type-name">UnsafeMkRangeTo</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(..&lt;i)` parses as `RangeToExc _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">RangeToExc</span> q<span class="symbol">:</span><span class="type-name">Type</span> i<span class="command">:q</span> <span class="symbol">=</span> <span class="type-name">UnsafeMkRangeToExc</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (<span class="type-name">RangeFrom</span> q i) <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  size <span class="symbol">=</span> unsafe_nat_diff (size q) (ordinal i)
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeFrom</span> j)<span class="symbol">.</span> j
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeFrom</span> j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (<span class="type-name">RangeFromExc</span> q i) <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  size <span class="symbol">=</span> unsafe_nat_diff (size q) (ordinal i <span class="symbol">+</span> 1)
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeFromExc</span> j)<span class="symbol">.</span> j
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeFromExc</span> j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (<span class="type-name">RangeTo</span> q i) <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  size <span class="symbol">=</span> ordinal i <span class="symbol">+</span> 1
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeTo</span> j)<span class="symbol">.</span> j
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeTo</span> j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (<span class="type-name">RangeToExc</span> q i) <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  size <span class="symbol">=</span> ordinal i
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeToExc</span> j)<span class="symbol">.</span> j
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeToExc</span> j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> <span class="type-name">Unit</span>
  size <span class="symbol">=</span> 1
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>_<span class="symbol">.</span> 0
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>_<span class="symbol">.</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iota (n<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> n] <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Nat</span> <span class="symbol">=</span> <span class="keyword">view</span> i<span class="symbol">.</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Arithmetic instances for table types</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">Add</span> a]
  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">Sub</span> a]
  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Add</span> a]  <span class="comment">-- Upper triangular tables
</span>  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Sub</span> a]  <span class="comment">-- Upper triangular tables
</span>  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Add</span> a]  <span class="comment">-- Lower triangular tables
</span>  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Sub</span> a]  <span class="comment">-- Lower triangular tables
</span>  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Add</span> a]
  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Sub</span> a]
  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Add</span> a]
  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">Sub</span> a]
  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">Mul</span> a]
  mul <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">*</span> ys<span class="symbol">.</span>i
  one <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> one
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Basic polymorphic functions and types</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) (b<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">PairType</span> a b
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">,</span>) {a b} (x<span class="command">:a</span>) (y<span class="command">:b</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">=</span> %pair x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fst {a b} ((x<span class="symbol">,</span> _)<span class="symbol">:</span> (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> snd {a b} ((_<span class="symbol">,</span> y)<span class="symbol">:</span> (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> b <span class="symbol">=</span> y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> swap {a b} ((x<span class="symbol">,</span> y)<span class="symbol">:</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (b<span class="symbol">&amp;</span>a) <span class="symbol">=</span> (y<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Add</span> a<span class="symbol">,</span> <span class="type-name">Add</span> b]
  add <span class="symbol">=</span> <span class="symbol">\</span>(a<span class="symbol">,</span> b) (c<span class="symbol">,</span> d)<span class="symbol">.</span> ( (a <span class="symbol">+</span> c)<span class="symbol">,</span> (b <span class="symbol">+</span> d))
  zero <span class="symbol">=</span> (zero<span class="symbol">,</span> zero)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Sub</span> a<span class="symbol">,</span> <span class="type-name">Sub</span> b]
  sub <span class="symbol">=</span> <span class="symbol">\</span>(a<span class="symbol">,</span> b) (c<span class="symbol">,</span> d)<span class="symbol">.</span> ( (a <span class="symbol">-</span> c)<span class="symbol">,</span> (b <span class="symbol">-</span> d))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Ix</span> a<span class="symbol">,</span> <span class="type-name">Ix</span> b]
  size <span class="symbol">=</span> size a <span class="symbol">*</span> size b
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>(i<span class="symbol">,</span> j)<span class="symbol">.</span> (ordinal i <span class="symbol">*</span> size b) <span class="symbol">+</span> ordinal j
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>o<span class="symbol">.</span>
    bs <span class="symbol">=</span> size b
    (unsafe_from_ordinal a (idiv o bs)<span class="symbol">,</span> unsafe_from_ordinal b (rem o bs))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&lt;&lt;</span>) {a b c} (f<span class="symbol">:</span> b <span class="symbol">-&gt;</span> c) (g<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> f (g x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;&gt;&gt;</span>) {a b c} (g<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) (f<span class="symbol">:</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> f (g x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> flip    {a b c} (f<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">:</span> (b <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> c) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> f y x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> uncurry {a b c} (f<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">-&gt;</span> c  <span class="symbol">=</span> <span class="symbol">\</span>(x<span class="symbol">,</span>y)<span class="symbol">.</span> f x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> const   {a b}   (x<span class="symbol">:</span> a) (_<span class="symbol">:</span> b) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Vector spaces</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> [<span class="type-name">Add</span> a<span class="symbol">,</span> <span class="type-name">Sub</span> a] <span class="type-name">VSpace</span> a
  scale_vec <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">.*</span>) {a} [<span class="type-name">VSpace</span> a] <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> scale_vec
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">*.</span>) {a} [<span class="type-name">VSpace</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">=</span> flip scale_vec
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/</span>)  {a} [<span class="type-name">VSpace</span> a] (v<span class="command">:a</span>) (s<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> a <span class="symbol">=</span> divide 1<span class="symbol">.</span>0 s <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> neg  {a} [<span class="type-name">VSpace</span> a] (v<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> (<span class="symbol">-</span>1<span class="symbol">.</span>0) <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> <span class="type-name">Float</span>
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> x <span class="symbol">*</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">VSpace</span> a]
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">VSpace</span> a<span class="symbol">,</span> <span class="type-name">VSpace</span> b]
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span> s (a<span class="symbol">,</span> b) <span class="symbol">.</span> (scale_vec s a<span class="symbol">,</span> scale_vec s b)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">VSpace</span> a]
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">VSpace</span> a]
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">VSpace</span> a]
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> ((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {a n} [<span class="type-name">VSpace</span> a]
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> (n<span class="symbol">-&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">VSpace</span> a]
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>s f<span class="symbol">.</span> <span class="symbol">\</span>x<span class="symbol">.</span> s <span class="symbol">.*</span> (f x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> <span class="type-name">Unit</span>
  scale_vec <span class="symbol">=</span> <span class="symbol">\</span>_ _<span class="symbol">.</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Boolean type</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="type-name">False</span>
  <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_w8 (x <span class="symbol">:</span> <span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Word8</span> <span class="symbol">=</span> %dataConTag x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w8_to_b (x <span class="symbol">:</span> <span class="type-name">Word8</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> %toEnum <span class="type-name">Bool</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&amp;</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> b_to_w8 x
  y&#39; <span class="symbol">=</span> b_to_w8 y
  w8_to_b <span class="symbol">$</span> %and x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">||</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> b_to_w8 x
  y&#39; <span class="symbol">=</span> b_to_w8 y
  w8_to_b <span class="symbol">$</span> %or x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> not  (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> b_to_w8 x
  w8_to_b <span class="symbol">$</span> %not x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>More Boolean operations</h2>
<p>TODO: move these with the others?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> select {a} (p<span class="symbol">:</span><span class="type-name">Bool</span>) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> <span class="keyword">case</span> p <span class="keyword">of</span>
  <span class="type-name">True</span>  <span class="symbol">-&gt;</span> x
  <span class="type-name">False</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_i (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Int</span>  <span class="symbol">=</span> w8_to_i <span class="symbol">$</span> b_to_w8 x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_n (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Nat</span>   <span class="symbol">=</span> w8_to_n <span class="symbol">$</span> b_to_w8 x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_f (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> i_to_f (b_to_i x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Ordering</h2>
<p>TODO: move this down to with <code>Ord</code>?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
  <span class="type-name">LT</span>
  <span class="type-name">EQ</span>
  <span class="type-name">GT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> o_to_w8 (x <span class="symbol">:</span> <span class="type-name">Ordering</span>) <span class="symbol">:</span> <span class="type-name">Word8</span> <span class="symbol">=</span> %dataConTag x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Sum types</h2>
<p>A <a href="https://en.wikipedia.org/wiki/Tagged_union">sum type, or tagged union</a> can hold values from a fixed set of types, distinguished by tags.
For those familiar with the C language, they can be though of as a combination of an <code>enum</code> with a <code>union</code>.
Here we define several basic kinds, and some operators on them.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Maybe</span> a <span class="symbol">=</span>
  <span class="type-name">Nothing</span>
  <span class="type-name">Just</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_nothing {a} (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
  <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">True</span>
  <span class="type-name">Just</span> _ <span class="symbol">-&gt;</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_just {a} (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not <span class="symbol">$</span> is_nothing x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maybe {a b} (d<span class="symbol">:</span> b) (f <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b)) (x<span class="symbol">:</span> <span class="type-name">Maybe</span> a) <span class="symbol">:</span> b <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> d
    <span class="type-name">Just</span> x&#39; <span class="symbol">-&gt;</span> f x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> (<span class="symbol">|</span>) a b <span class="symbol">=</span>
  <span class="type-name">Left</span>  a
  <span class="type-name">Right</span> b
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (a <span class="symbol">|</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Ix</span> a<span class="symbol">,</span> <span class="type-name">Ix</span> b]
  size <span class="symbol">=</span> size a <span class="symbol">+</span> size b
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>i<span class="symbol">.</span> <span class="keyword">case</span> i <span class="keyword">of</span>
    <span class="type-name">Left</span> ai  <span class="symbol">-&gt;</span> ordinal ai
    <span class="type-name">Right</span> bi <span class="symbol">-&gt;</span> ordinal bi <span class="symbol">+</span> size a
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>o<span class="symbol">.</span>
    as <span class="symbol">=</span> nat_to_rep <span class="symbol">$</span> size a
    o&#39; <span class="symbol">=</span> nat_to_rep o
    <span class="comment">-- TODO: Reshuffle the prelude to be able to use (&lt;) here
</span>    <span class="keyword">case</span> w8_to_b <span class="symbol">$</span> %ilt o&#39; as <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Left</span> <span class="symbol">$</span> unsafe_from_ordinal a o
      <span class="comment">-- TODO: Reshuffle the prelude to be able to use `diff_nat` here
</span>      <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Right</span> <span class="symbol">$</span> unsafe_from_ordinal b (rep_to_nat (%isub o&#39; as))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Subtraction on Nats</h2>
<p>-- TODO: think more about the right API here</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_i_to_n (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  rep_to_nat <span class="symbol">$</span> internal_cast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_i (x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span>
  internal_cast _ <span class="symbol">$</span> nat_to_rep x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_n (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  <span class="keyword">if</span> w8_to_b <span class="symbol">$</span> %ilt x (0<span class="symbol">::</span><span class="type-name">Int</span>)
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> unsafe_i_to_n x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Fencepost index sets</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Post</span> segment<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">UnsafeMkPost</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (<span class="type-name">Post</span> segment) <span class="keyword">given</span> {segment} [<span class="type-name">Ix</span> segment]
  size <span class="symbol">=</span> size segment <span class="symbol">+</span> 1
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkPost</span> i)<span class="symbol">.</span> i
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>i<span class="symbol">.</span> <span class="type-name">UnsafeMkPost</span> i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> left_post {n} [<span class="type-name">Ix</span> n] (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Post</span> n <span class="symbol">=</span>
  unsafe_from_ordinal (<span class="type-name">Post</span> n) (ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> right_post {n} [<span class="type-name">Ix</span> n] (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Post</span> n <span class="symbol">=</span>
  unsafe_from_ordinal (<span class="type-name">Post</span> n) (ordinal i <span class="symbol">+</span> 1)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> [<span class="type-name">Ix</span> n] <span class="type-name">NonEmpty</span> n
  first_ix <span class="symbol">:</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> last_ix {n} [<span class="type-name">NonEmpty</span> n] <span class="symbol">:</span> n <span class="symbol">=</span>
  unsafe_from_ordinal _ <span class="symbol">$</span> unsafe_i_to_n <span class="symbol">$</span> n_to_i (size n) <span class="symbol">-</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span> (<span class="type-name">Post</span> n) <span class="keyword">given</span> {n} [<span class="type-name">Ix</span> n]
  first_ix <span class="symbol">=</span> unsafe_from_ordinal (<span class="type-name">Post</span> n) 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span> <span class="type-name">Unit</span>
  first_ix <span class="symbol">=</span> unsafe_from_ordinal _ 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Monoid</h3>
<p>A <a href="https://en.wikipedia.org/wiki/Monoid">monoid</a> is a things that have an associative binary operator and an identity element.
This is a very useful and general calls of things.
It includes:</p>
<ul>
<li>Addition and Multiplication of Numbers</li>
<li>Boolean Logic</li>
<li>Concatenation of Lists (including strings)
Monoids support <code>fold</code> operations, and similar.</li>
</ul>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Monoid</span> a
  mempty <span class="symbol">:</span> a
  mcombine <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a  <span class="comment">-- can&#39;t use `&lt;&gt;` just for parser reasons?
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>) {a} [<span class="type-name">Monoid</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> mcombine
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">Monoid</span> a]
  mempty <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> mempty
  mcombine <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> mcombine x<span class="symbol">.</span>i y<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">AndMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> <span class="type-name">Bool</span>
  mempty <span class="symbol">=</span> <span class="type-name">True</span>
  mcombine <span class="symbol">=</span> (<span class="symbol">&amp;&amp;</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">OrMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> <span class="type-name">Bool</span>
  mempty <span class="symbol">=</span> <span class="type-name">False</span>
  mcombine <span class="symbol">=</span> (<span class="symbol">||</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">AddMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> a <span class="keyword">given</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Add</span> a]
  mempty <span class="symbol">=</span> zero
  mcombine <span class="symbol">=</span> add
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">MulMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> a <span class="keyword">given</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Mul</span> a]
  mempty <span class="symbol">=</span> one
  mcombine <span class="symbol">=</span> mul
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Effects</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Ref</span> (r<span class="symbol">:</span><span class="type-name">Type</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Ref</span> r a
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get  {h s} (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s)       <span class="symbol">:</span> {<span class="type-name">State</span> h} s    <span class="symbol">=</span> %get  ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">:=</span>) {h s} (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s) (x<span class="command">:s</span>) <span class="symbol">:</span> {<span class="type-name">State</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span> %put  ref x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ask  {h r} (ref<span class="symbol">:</span><span class="type-name">Ref</span> h r)       <span class="symbol">:</span> {<span class="type-name">Read</span>  h} r    <span class="symbol">=</span> %ask  ref
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">AccumMonoidData</span> h w <span class="symbol">=</span>
  <span class="type-name">UnsafeMkAccumMonoidData</span> b<span class="symbol">:</span><span class="type-name">Type</span> (<span class="type-name">Monoid</span> b)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">AccumMonoid</span> h w
  getAccumMonoidData <span class="symbol">:</span> <span class="type-name">AccumMonoidData</span> h w
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">AccumMonoid</span> h (n<span class="symbol">=&gt;</span>w) <span class="keyword">given</span> {n h w} [<span class="type-name">Ix</span> n] [am <span class="symbol">:</span> <span class="type-name">AccumMonoid</span> h w]
  getAccumMonoidData <span class="symbol">=</span>
    (<span class="type-name">UnsafeMkAccumMonoidData</span> b bm) <span class="symbol">=</span> %projMethod0 am
    <span class="type-name">UnsafeMkAccumMonoidData</span> b bm
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+=</span>) {h w} [am<span class="symbol">:</span><span class="type-name">AccumMonoid</span> h w] (ref<span class="symbol">:</span><span class="type-name">Ref</span> h w) (x<span class="command">:w</span>) <span class="symbol">:</span> {<span class="type-name">Accum</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">UnsafeMkAccumMonoidData</span> b bm) <span class="symbol">=</span> %projMethod0 am
  empty <span class="symbol">=</span> %projMethod0 bm
  combine <span class="symbol">=</span> %projMethod1 bm
  %mextend ref empty (<span class="symbol">\</span>x y<span class="symbol">.</span> combine x y) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">!</span>) {h n a} (ref<span class="symbol">:</span><span class="type-name">Ref</span> h (n<span class="symbol">=&gt;</span>a)) (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %indexRef ref i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fst_ref {h a b} (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %fstRef ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> snd_ref {h a b} (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h b <span class="symbol">=</span> %sndRef ref
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> run_reader
      {r a eff}
      (init<span class="command">:r</span>)
      (action<span class="symbol">:</span> ((h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h r <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; r) <span class="symbol">:</span> {<span class="type-name">Read</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runReader init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_reader
      {r a eff}
      (init<span class="command">:r</span>)
      (action<span class="symbol">:</span> ((h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h r <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    run_reader init action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">MonoidLifter</span> (b<span class="symbol">:</span><span class="type-name">Type</span>) (w<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> (h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">AccumMonoid</span> h b <span class="symbol">?=&gt;</span> <span class="type-name">AccumMonoid</span> h w
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> run_accum
      {a b w eff}
      [mlift<span class="symbol">:</span><span class="type-name">MonoidLifter</span> b w]
      (bm<span class="symbol">:</span><span class="type-name">Monoid</span> b)
      (action<span class="symbol">:</span> ((h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">AccumMonoid</span> h b <span class="symbol">?=&gt;</span> <span class="type-name">Ref</span> h w <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> w) <span class="symbol">=</span>
  empty <span class="symbol">=</span> %projMethod0 bm
  combine <span class="symbol">=</span> %projMethod1 bm
  <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; w) <span class="symbol">:</span> {<span class="type-name">Accum</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    accumMonoidData <span class="symbol">:</span> (<span class="type-name">AccumMonoidData</span> h&#39; b) <span class="symbol">=</span> <span class="type-name">UnsafeMkAccumMonoidData</span> b bm
    accumBaseMonoid <span class="symbol">=</span> %explicitDict (<span class="type-name">AccumMonoid</span> h&#39; b) accumMonoidData
    action&#39; <span class="symbol">=</span> %explicitApply (%explicitApply action h&#39;) accumBaseMonoid
    action&#39; ref
  %runWriter empty (<span class="symbol">\</span>x y<span class="symbol">.</span> combine x y) explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> yield_accum
      {a b w eff}
      [mlift<span class="symbol">:</span><span class="type-name">MonoidLifter</span> b w]
      (m<span class="symbol">:</span><span class="type-name">Monoid</span> b)
      (action<span class="symbol">:</span> ((h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">AccumMonoid</span> h b <span class="symbol">?=&gt;</span> <span class="type-name">Ref</span> h w <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} w <span class="symbol">=</span>
  snd <span class="symbol">$</span> run_accum m action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> run_state
      {a s eff}
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a)
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> s) <span class="symbol">=</span>
  <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; s) <span class="symbol">:</span> {<span class="type-name">State</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
  %runState init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_state
      {a s eff}
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a)
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span> fst <span class="symbol">$</span> run_state init action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> yield_state
      {a s eff}
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a)
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} s <span class="symbol">=</span> snd <span class="symbol">$</span> run_state init action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_io {a eff} (f<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span><span class="symbol">|</span>eff} a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
  %runIO f
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unreachable {a} (()<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> a <span class="symbol">=</span> unsafe_io <span class="keyword">do</span>
  %throwError a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Type classes</h2>
</div></div><div class="cell"><div class="prose-block"><h3>Eq and Ord</h3>
</div></div><div class="cell"><div class="prose-block"><h4>Eq</h4>
<p>Equatable.
Things that we can tell if they are equal or not to other things.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Eq</span> a
  (<span class="symbol">==</span>) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/=</span>) {a} [<span class="type-name">Eq</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not <span class="symbol">$</span> x <span class="symbol">==</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Ord</h4>
<p>Orderable / Comparable.
Things that can be place in a total order.
i.e. things that can be compared to other things to find if larger, smaller or equal in value.</p>
</div></div><div class="cell"><div class="prose-block"><p>We take the standard false-hood and pretend that this applies to Floats, even though strictly speaking this not true as our floats follow <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE754</a>, and thus have <code>NaN &lt; 1.0 == false</code> and <code>1.0 &lt; NaN == false</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> [<span class="type-name">Eq</span> a] <span class="type-name">Ord</span> a
  (<span class="symbol">&gt;</span>) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
  (<span class="symbol">&lt;</span>) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;=</span>) {a} [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&lt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;=</span>) {a} [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&gt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Float64</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %feq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Float32</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %feq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Int64</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Int32</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Word8</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Word32</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Word64</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Bool</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> b_to_w8 x <span class="symbol">==</span> b_to_w8 y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Unit</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> (a <span class="symbol">|</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Eq</span> a<span class="symbol">,</span> <span class="type-name">Eq</span> b]
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span> x <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Left</span> y <span class="symbol">-&gt;</span> x <span class="symbol">==</span> y
      <span class="type-name">Right</span> y <span class="symbol">-&gt;</span> <span class="type-name">False</span>
    <span class="type-name">Right</span> x <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Left</span> y <span class="symbol">-&gt;</span> <span class="type-name">False</span>
      <span class="type-name">Right</span> y <span class="symbol">-&gt;</span> x <span class="symbol">==</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> (<span class="type-name">Maybe</span> a) <span class="keyword">given</span> {a} [<span class="type-name">Eq</span> a]
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Just</span> x <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Just</span> y <span class="symbol">-&gt;</span> x <span class="symbol">==</span> y
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">False</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Just</span> y <span class="symbol">-&gt;</span> <span class="type-name">False</span>
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">RawPtr</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> raw_ptr_to_i64 x <span class="symbol">==</span> raw_ptr_to_i64 y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Float64</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %fgt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %flt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Float32</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %fgt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %flt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Int64</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Int32</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Word8</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Word32</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Word64</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> w8_to_b <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Unit</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Eq</span> a<span class="symbol">,</span> <span class="type-name">Eq</span> b]
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">==</span> y2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Ord</span> a<span class="symbol">,</span> <span class="type-name">Ord</span> b]
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&gt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&gt;</span> y2)
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&lt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&lt;</span> y2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Ordering</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> o_to_w8 x <span class="symbol">==</span> o_to_w8 y
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Nat</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> nat_to_rep x <span class="symbol">==</span> nat_to_rep y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Nat</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> nat_to_rep x <span class="symbol">&gt;</span> nat_to_rep y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> nat_to_rep x <span class="symbol">&lt;</span> nat_to_rep y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want Eq and Ord for all index sets, not just `Fin n`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> (<span class="type-name">Fin</span> n) <span class="keyword">given</span> {n}
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">==</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> (<span class="type-name">Fin</span> n) <span class="keyword">given</span> {n}
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&gt;</span> ordinal y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&lt;</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> <span class="type-name">Bool</span>
  size <span class="symbol">=</span> 2
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>b<span class="symbol">.</span> <span class="keyword">case</span> b <span class="keyword">of</span>
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> 0
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> 1
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>i<span class="symbol">.</span> i <span class="symbol">&gt;</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (<span class="type-name">Maybe</span> a) <span class="keyword">given</span> {a} [<span class="type-name">Ix</span> a]
  size <span class="symbol">=</span> size a <span class="symbol">+</span> 1
  ordinal <span class="symbol">=</span> <span class="symbol">\</span>i<span class="symbol">.</span> <span class="keyword">case</span> i <span class="keyword">of</span>
    <span class="type-name">Just</span> ai <span class="symbol">-&gt;</span> ordinal ai
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> size a
  unsafe_from_ordinal <span class="symbol">=</span> <span class="symbol">\</span>o<span class="symbol">.</span>
    <span class="keyword">case</span> o <span class="symbol">==</span> size a <span class="keyword">of</span>
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> unsafe_from_ordinal _ o
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span> <span class="type-name">Bool</span>
  first_ix <span class="symbol">=</span> unsafe_from_ordinal _ 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">NonEmpty</span> a<span class="symbol">,</span> <span class="type-name">NonEmpty</span> b]
  first_ix <span class="symbol">=</span> unsafe_from_ordinal _ 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span> (a<span class="symbol">|</span>b) <span class="keyword">given</span> {a b} [<span class="type-name">Ix</span> b<span class="symbol">,</span> <span class="type-name">NonEmpty</span> a]
  first_ix <span class="symbol">=</span> unsafe_from_ordinal _ 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- The below instance is valid, but causes &quot;multiple candidate dictionaries&quot;
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- errors if both Left and Right are NonEmpty.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- instance NonEmpty (a|b) given {a b} [Ix a, NonEmpty b]
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--  first_ix = unsafe_from_ordinal _ 0
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span> (<span class="type-name">Maybe</span> a) <span class="keyword">given</span> {a} [<span class="type-name">Ix</span> a]
  first_ix <span class="symbol">=</span> unsafe_from_ordinal _ 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan {a b n} [<span class="type-name">Ix</span> n] (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span>
  swap <span class="symbol">$</span> run_state init <span class="symbol">\</span>s<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    c <span class="symbol">=</span> get s
    (c&#39;<span class="symbol">,</span> y) <span class="symbol">=</span> body i c
    s <span class="symbol">:=</span> c&#39;
    y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fold {a n} [<span class="type-name">Ix</span> n] (init<span class="command">:a</span>) (body<span class="symbol">:</span>(n<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) <span class="symbol">:</span> a <span class="symbol">=</span> fst <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> (body i x<span class="symbol">,</span> ())
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> compare {a} [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
  <span class="keyword">if</span> x <span class="symbol">&lt;</span> y
    <span class="keyword">then</span> <span class="type-name">LT</span>
    <span class="keyword">else</span> <span class="keyword">if</span> x <span class="symbol">==</span> y
      <span class="keyword">then</span> <span class="type-name">EQ</span>
      <span class="keyword">else</span> <span class="type-name">GT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span> <span class="type-name">Ordering</span>
  mempty <span class="symbol">=</span> <span class="type-name">EQ</span>
  mcombine <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
    <span class="keyword">case</span> x <span class="keyword">of</span>
      <span class="type-name">LT</span> <span class="symbol">-&gt;</span> <span class="type-name">LT</span>
      <span class="type-name">GT</span> <span class="symbol">-&gt;</span> <span class="type-name">GT</span>
      <span class="type-name">EQ</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">Eq</span> a]
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    yield_accum <span class="type-name">AndMonoid</span> <span class="symbol">\</span>ref<span class="symbol">.</span>
      <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs<span class="symbol">.</span>i <span class="symbol">==</span> ys<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">Ord</span> a]
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    f<span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
        fold <span class="type-name">EQ</span> <span class="symbol">$</span> <span class="symbol">\</span>i c<span class="symbol">.</span> c <span class="symbol">&lt;&gt;</span> (compare xs<span class="symbol">.</span>i ys<span class="symbol">.</span>i)
    f <span class="symbol">==</span> <span class="type-name">GT</span>
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    f<span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
        fold <span class="type-name">EQ</span> <span class="symbol">$</span> <span class="symbol">\</span>i c<span class="symbol">.</span> c <span class="symbol">&lt;&gt;</span> (compare xs<span class="symbol">.</span>i ys<span class="symbol">.</span>i)
    f <span class="symbol">==</span> <span class="type-name">LT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Subset class</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Subset</span> a_sub a
  inject&#39;         <span class="symbol">:</span> a_sub <span class="symbol">-&gt;</span> a
  project&#39;        <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> a_sub
  unsafe_project&#39; <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a_sub
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> project {a} (a_sub<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Subset</span> a_sub a] (x<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> a_sub <span class="symbol">=</span>
  project&#39; x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_project {a} (a_sub<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Subset</span> a_sub a] (x<span class="command">:a</span>) <span class="symbol">:</span> a_sub <span class="symbol">=</span>
  unsafe_project&#39; x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> inject {a_sub} (a<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Subset</span> a_sub a] (x<span class="command">:a</span>_sub) <span class="symbol">:</span> a <span class="symbol">=</span>
  inject&#39; x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> a c <span class="keyword">given</span> {a b c} [<span class="type-name">Subset</span> a b<span class="symbol">,</span> <span class="type-name">Subset</span> b c]
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> inject c <span class="symbol">$</span> inject b x
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> project b x <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Just</span> y <span class="symbol">-&gt;</span> project a y
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafe_project a <span class="symbol">$</span> unsafe_project b x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_project_rangefrom {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q] (j<span class="command">:q</span>) <span class="symbol">:</span> <span class="type-name">RangeFrom</span> q i <span class="symbol">=</span>
  <span class="type-name">UnsafeMkRangeFrom</span> <span class="symbol">$</span> unsafe_nat_diff (ordinal j) (ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> (<span class="type-name">RangeFrom</span> q i) q <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeFrom</span> j)<span class="symbol">.</span>
    unsafe_from_ordinal _ <span class="symbol">$</span> j <span class="symbol">+</span> ordinal i
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&lt;</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">UnsafeMkRangeFrom</span> <span class="symbol">$</span> unsafe_nat_diff j&#39; i&#39;
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeFrom</span> <span class="symbol">$</span> unsafe_nat_diff (ordinal j) (ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> (<span class="type-name">RangeFromExc</span> q i) q <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeFromExc</span> j)<span class="symbol">.</span>
    unsafe_from_ordinal _ <span class="symbol">$</span> j <span class="symbol">+</span> ordinal i <span class="symbol">+</span> 1
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&lt;=</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">UnsafeMkRangeFromExc</span> <span class="symbol">$</span> unsafe_nat_diff j&#39; (i&#39; <span class="symbol">+</span> 1)
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span>
    <span class="type-name">UnsafeMkRangeFromExc</span> <span class="symbol">$</span> unsafe_nat_diff (ordinal j) (ordinal i <span class="symbol">+</span> 1)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> (<span class="type-name">RangeTo</span> q i) q <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeTo</span> j)<span class="symbol">.</span> unsafe_from_ordinal _ j
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&gt;</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">UnsafeMkRangeTo</span> j&#39;
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeTo</span> (ordinal j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> (<span class="type-name">RangeToExc</span> q i) q <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeToExc</span> j)<span class="symbol">.</span> unsafe_from_ordinal _ j
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&gt;=</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">UnsafeMkRangeToExc</span> j&#39;
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeToExc</span> (ordinal j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> (<span class="type-name">RangeToExc</span> q i) (<span class="type-name">RangeTo</span> q i) <span class="keyword">given</span> {q<span class="symbol">:</span><span class="type-name">Type</span>} {i<span class="command">:q</span>} [<span class="type-name">Ix</span> q]
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">UnsafeMkRangeToExc</span> j)<span class="symbol">.</span> unsafe_from_ordinal _ j
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&gt;=</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">UnsafeMkRangeToExc</span> j&#39;
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>j<span class="symbol">.</span> <span class="type-name">UnsafeMkRangeToExc</span> (ordinal j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Elementary/Special Functions</h2>
<p>This is more or less the standard <a href="https://en.wikipedia.org/wiki/C_mathematical_functions">LibM fare</a>.
Roughly it lines up with some definitions of the set of <a href="https://en.wikipedia.org/wiki/Elementary_function">Elementary</a> and/or <a href="https://en.wikipedia.org/wiki/Special_functions">Special</a>.
In truth, nothing is elementary or special except that we humans have decided it is.
Many, but not all of these functions are <a href="https://en.wikipedia.org/wiki/Transcendental_function">Transcendental</a>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Floating</span> a
  exp    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  exp2   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log2   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log10  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log1p  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sin    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  cos    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  tan    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sinh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  cosh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  tanh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  floor  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  ceil   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  round  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sqrt   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  pow    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  lgamma <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  erf    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  erfc   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lbeta {a} [<span class="type-name">Sub</span> a<span class="symbol">,</span> <span class="type-name">Floating</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> lgamma x <span class="symbol">+</span> lgamma y <span class="symbol">-</span> lgamma (x <span class="symbol">+</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: better numerics for very large and small values.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- Using %exp here to avoid circular definition problems.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_sinh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_cosh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fadd (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_tanh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) (%fadd (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x)))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: unify this with float32 functions.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_sinh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub (f_to_f64 0<span class="symbol">.</span>0) x))) (f_to_f64 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_cosh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv (%fadd (%exp x) (%exp (%fsub (f_to_f64 0<span class="symbol">.</span>0) x))) (f_to_f64 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_tanh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> (%fdiv (%fsub (%exp x) (%exp (%fsub (f_to_f64 0<span class="symbol">.</span>0) x)))
                                                (%fadd (%exp x) (%exp (%fsub (f_to_f64 0<span class="symbol">.</span>0) x))))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span> <span class="type-name">Float64</span>
  exp    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp x
  exp2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp2   x
  log    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log    x
  log2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log2   x
  log10  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log10  x
  log1p  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log1p  x
  sin    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sin    x
  cos    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %cos    x
  tan    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %tan    x
  sinh   <span class="symbol">=</span> float64_sinh
  cosh   <span class="symbol">=</span> float64_cosh
  tanh   <span class="symbol">=</span> float64_tanh
  floor  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %floor  x
  ceil   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %ceil   x
  round  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %round  x
  sqrt   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sqrt   x
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fpow x y
  lgamma <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %lgamma x
  erf    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %erf    x
  erfc   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %erfc   x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span> <span class="type-name">Float32</span>
  exp    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp x
  exp2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp2   x
  log    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log    x
  log2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log2   x
  log10  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log10  x
  log1p  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log1p  x
  sin    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sin    x
  cos    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %cos    x
  tan    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %tan    x
  sinh   <span class="symbol">=</span> float32_sinh
  cosh   <span class="symbol">=</span> float32_cosh
  tanh   <span class="symbol">=</span> float32_tanh
  floor  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %floor  x
  ceil   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %ceil   x
  round  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %round  x
  sqrt   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sqrt   x
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fpow x y
  lgamma <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %lgamma x
  erf    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %erf    x
  erfc   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %erfc   x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Raw pointer operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Ptr</span> a <span class="symbol">=</span> <span class="type-name">MkPtr</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cast_ptr {a b} (ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> a) <span class="symbol">:</span> <span class="type-name">Ptr</span> b <span class="symbol">=</span>
  (<span class="type-name">MkPtr</span> rawPtr) <span class="symbol">=</span> ptr
  <span class="type-name">MkPtr</span> rawPtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Storable</span> a
  store <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span>
  load  <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span>      {<span class="type-name">IO</span>} a
  storage_size a <span class="symbol">:</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Word8</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> %ptrStore ptr x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)  <span class="symbol">.</span> %ptrLoad  ptr
  storage_size <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Int32</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> %ptrStore (internal_cast %<span class="type-name">Int32Ptr</span> ptr) x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)  <span class="symbol">.</span> %ptrLoad  (internal_cast %<span class="type-name">Int32Ptr</span> ptr)
  storage_size <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Word32</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> %ptrStore (internal_cast %<span class="type-name">Word32Ptr</span> ptr) x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)  <span class="symbol">.</span> %ptrLoad  (internal_cast %<span class="type-name">Word32Ptr</span> ptr)
  storage_size <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Float32</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> %ptrStore (internal_cast %<span class="type-name">Float32Ptr</span> ptr) x
  load <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)   <span class="symbol">.</span> %ptrLoad  (internal_cast %<span class="type-name">Float32Ptr</span> ptr)
  storage_size <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Nat</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> store (<span class="type-name">MkPtr</span> ptr) <span class="symbol">$</span> nat_to_rep x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)  <span class="symbol">.</span> rep_to_nat <span class="symbol">$</span> load (<span class="type-name">MkPtr</span> ptr)
  storage_size <span class="symbol">=</span> storage_size <span class="type-name">NatRep</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> (<span class="type-name">Ptr</span> a) <span class="keyword">given</span> {a}
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) (<span class="type-name">MkPtr</span> x)<span class="symbol">.</span>         %ptrStore (internal_cast %<span class="type-name">PtrPtr</span> ptr) x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)          <span class="symbol">.</span> <span class="type-name">MkPtr</span> <span class="symbol">$</span> %ptrLoad  (internal_cast %<span class="type-name">PtrPtr</span> ptr)
  storage_size <span class="symbol">=</span> 8  <span class="comment">-- TODO: something more portable?
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Storable instances for other types
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> malloc {a} [<span class="type-name">Storable</span> a] (n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">Ptr</span> a) <span class="symbol">=</span>
  numBytes <span class="symbol">=</span> storage_size a <span class="symbol">*</span> n
  <span class="type-name">MkPtr</span> <span class="symbol">$</span> %alloc (nat_to_rep numBytes)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> free {a} (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">MkPtr</span> ptr&#39;) <span class="symbol">=</span> ptr
  %free ptr&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+&gt;&gt;</span>) {a} [<span class="type-name">Storable</span> a] (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) (i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">=</span>
  (<span class="type-name">MkPtr</span> ptr&#39;) <span class="symbol">=</span> ptr
  i&#39; <span class="symbol">=</span> nat_to_rep <span class="symbol">$</span> i <span class="symbol">*</span> storage_size a
  <span class="type-name">MkPtr</span> <span class="symbol">$</span> %ptrOffset ptr&#39; i&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: consider making a Storable instance for tables instead
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> store_table {a n} [<span class="type-name">Storable</span> a] (ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> a) (tab<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  <span class="keyword">for</span>_ i<span class="symbol">.</span> store (ptr <span class="symbol">+&gt;&gt;</span> ordinal i) tab<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> memcpy {a} [<span class="type-name">Storable</span> a] (dest<span class="symbol">:</span><span class="type-name">Ptr</span> a) (src<span class="symbol">:</span><span class="type-name">Ptr</span> a) (n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  <span class="keyword">for</span>_ i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    store (dest <span class="symbol">+&gt;&gt;</span> i&#39;) (load <span class="symbol">$</span> src <span class="symbol">+&gt;&gt;</span> i&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: generalize these brackets to allow other effects
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: make sure that freeing happens even if there are run-time errors
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_alloc {a b} [<span class="type-name">Storable</span> a] (n<span class="symbol">:</span><span class="type-name">Nat</span>) (action<span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b) <span class="symbol">:</span> {<span class="type-name">IO</span>} b <span class="symbol">=</span>
  ptr <span class="symbol">=</span> malloc n
  result <span class="symbol">=</span> action ptr
  free ptr
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_table_ptr {a b n} [<span class="type-name">Storable</span> a] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (action <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b) <span class="symbol">:</span> {<span class="type-name">IO</span>} b <span class="symbol">=</span>
  ptr <span class="symbol">&lt;-</span> with_alloc (size n)
  <span class="keyword">for</span> i<span class="symbol">.</span> store (ptr <span class="symbol">+&gt;&gt;</span> ordinal i) xs<span class="symbol">.</span>i
  action ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> table_from_ptr {a} [<span class="type-name">Storable</span> a] (n<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> n] (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> load <span class="symbol">$</span> ptr <span class="symbol">+&gt;&gt;</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Miscellaneous common utilities</h2>
</div></div><div class="cell"><div class="code-block">pi <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> 3<span class="symbol">.</span>141592653589793
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> id {a} (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dup {a} (x<span class="command">:a</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> a) <span class="symbol">=</span> (x<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> map {a b n eff} (f<span class="command">:a</span><span class="symbol">-&gt;</span>{<span class="symbol">|</span>eff} b) (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} (n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> f xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> zip {a b n} (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (ys<span class="command">:n</span><span class="symbol">=&gt;</span>b) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">=</span> <span class="keyword">view</span> i<span class="symbol">.</span> (xs<span class="symbol">.</span>i<span class="symbol">,</span> ys<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unzip {a b n} (xys<span class="command">:n</span><span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> (map fst xys<span class="symbol">,</span> map snd xys)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fanout {a} (n<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> n] (x<span class="command">:a</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> <span class="keyword">view</span> i<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sq  {a} [<span class="type-name">Mul</span> a] (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x <span class="symbol">*</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> abs {a} [<span class="type-name">Sub</span> a<span class="symbol">,</span> <span class="type-name">Ord</span> a] (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (x <span class="symbol">&gt;</span> zero) x (zero <span class="symbol">-</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mod {a} [<span class="type-name">Add</span> a<span class="symbol">,</span> <span class="type-name">Integral</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> rem (y <span class="symbol">+</span> rem x y) y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Table Operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">Floating</span> a]
  exp    <span class="symbol">=</span> map exp
  exp2   <span class="symbol">=</span> map exp2
  log    <span class="symbol">=</span> map log
  log2   <span class="symbol">=</span> map log2
  log10  <span class="symbol">=</span> map log10
  log1p  <span class="symbol">=</span> map log1p
  sin    <span class="symbol">=</span> map sin
  cos    <span class="symbol">=</span> map cos
  tan    <span class="symbol">=</span> map tan
  sinh   <span class="symbol">=</span> map sinh
  cosh   <span class="symbol">=</span> map cosh
  tanh   <span class="symbol">=</span> map tanh
  floor  <span class="symbol">=</span> map floor
  ceil   <span class="symbol">=</span> map ceil
  round  <span class="symbol">=</span> map round
  sqrt   <span class="symbol">=</span> map sqrt
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> pow x<span class="symbol">.</span>i y<span class="symbol">.</span>i
  lgamma <span class="symbol">=</span> map lgamma
  erf    <span class="symbol">=</span> map erf
  erfc   <span class="symbol">=</span> map erfc
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Axis Restructuring</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> axis1 {a b c} (x <span class="symbol">:</span> a <span class="symbol">=&gt;</span> b <span class="symbol">=&gt;</span> c) <span class="symbol">:</span> b <span class="symbol">=&gt;</span> a <span class="symbol">=&gt;</span> c <span class="symbol">=</span> <span class="keyword">for</span> j<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> axis2 {a b c d} (x <span class="symbol">:</span> a <span class="symbol">=&gt;</span> b <span class="symbol">=&gt;</span> c <span class="symbol">=&gt;</span> d) <span class="symbol">:</span> c <span class="symbol">=&gt;</span> a <span class="symbol">=&gt;</span> b <span class="symbol">=&gt;</span> d <span class="symbol">=</span> <span class="keyword">for</span> k<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">for</span> j<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j<span class="symbol">.</span>k
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reindex {a b v} [<span class="type-name">Ix</span> b] (ixr<span class="symbol">:</span> b <span class="symbol">-&gt;</span> a) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>v <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> tab<span class="symbol">.</span>(ixr i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Reductions</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `combine` should be a commutative and associative, and form a
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- commutative monoid with `identity`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reduce {a n} (identity<span class="command">:a</span>) (combine<span class="symbol">:</span>(a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  <span class="comment">-- TODO: implement with the accumulator effect
</span>  fold identity (<span class="symbol">\</span>i c<span class="symbol">.</span> combine c xs<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: call this `scan` and call the current `scan` something else
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan&#39; {a n} [<span class="type-name">Ix</span> n] (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> snd <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> dup (body i x)
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: allow tables-via-lambda and get rid of this
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fsum {n} (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> yield_accum (<span class="type-name">AddMonoid</span> <span class="type-name">Float</span>) <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sum  {n v} [<span class="type-name">Add</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce zero (<span class="symbol">+</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> prod {n v} [<span class="type-name">Mul</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce one  (<span class="symbol">*</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mean {n v} [<span class="type-name">VSpace</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> sum xs <span class="symbol">/</span> n_to_f (size n)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> std  {n v} [<span class="type-name">Mul</span> v<span class="symbol">,</span> <span class="type-name">Sub</span> v<span class="symbol">,</span> <span class="type-name">VSpace</span> v<span class="symbol">,</span> <span class="type-name">Floating</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> sqrt <span class="symbol">$</span> mean (map sq xs) <span class="symbol">-</span> sq (mean xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> any {n} (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">False</span> (<span class="symbol">||</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> all {n} (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">True</span>  (<span class="symbol">&amp;&amp;</span>) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>apply_n</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> apply_n {a} (n<span class="symbol">:</span><span class="type-name">Nat</span>) (x<span class="command">:a</span>) (f<span class="command">:a</span> <span class="symbol">-&gt;</span> a) <span class="symbol">:</span> a <span class="symbol">=</span>
  yield_state x <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> _<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    ref <span class="symbol">:=</span> f (get ref)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Linear Algebra</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linspace (n<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> n] (low<span class="symbol">:</span><span class="type-name">Float</span>) (high<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  dx <span class="symbol">=</span> (high <span class="symbol">-</span> low) <span class="symbol">/</span> n_to_f (size n)
  <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> low <span class="symbol">+</span> n_to_f (ordinal i) <span class="symbol">*</span> dx
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transpose {n m a} (x<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> <span class="keyword">view</span> i j<span class="symbol">.</span> x<span class="symbol">.</span>j<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vdot {n} (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (y<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> fsum <span class="keyword">view</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> y<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dot {n v} [<span class="type-name">VSpace</span> v] (s<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (vs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> sum <span class="keyword">for</span> j<span class="symbol">.</span> s<span class="symbol">.</span>j <span class="symbol">.*</span> vs<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- matmul. Better symbol to use? `@`?
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Improve auto-quantification to hoist the Ix n constraint to the type binder
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">**</span>) {l m n} [<span class="type-name">Ix</span> n] (x<span class="symbol">:</span> l<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (y<span class="symbol">:</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> (l<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span>
  <span class="keyword">for</span> i k<span class="symbol">.</span> fsum <span class="keyword">view</span> j<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y<span class="symbol">.</span>j<span class="symbol">.</span>k
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">**.</span>) {n m} (mat<span class="symbol">:</span> n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (v<span class="symbol">:</span> m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> vdot mat<span class="symbol">.</span>i v
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">.**</span>) {n m} (v<span class="symbol">:</span> m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (mat<span class="symbol">:</span> n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> mat <span class="symbol">**.</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> inner {n m} (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (mat<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (y<span class="command">:m</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  fsum <span class="keyword">view</span> (i<span class="symbol">,</span>j)<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> mat<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> eye {n a} [<span class="type-name">Add</span> a<span class="symbol">,</span> <span class="type-name">Mul</span> a<span class="symbol">,</span> <span class="type-name">Ix</span> n] <span class="symbol">:</span> n<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> select (ordinal i <span class="symbol">==</span> ordinal j) one zero
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>cumulative sum</h2>
<p>TODO: Move this to be with reductions?
It's a kind of <code>scan</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cumsum {n a} [<span class="type-name">Add</span> a] (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  total <span class="symbol">&lt;-</span> with_state zero
  <span class="keyword">for</span> i<span class="symbol">.</span>
    newTotal <span class="symbol">=</span> get total <span class="symbol">+</span> xs<span class="symbol">.</span>i
    total <span class="symbol">:=</span> newTotal
    newTotal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cumsum_low {n a} [<span class="type-name">Add</span> a] (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  total <span class="symbol">&lt;-</span> with_state zero
  <span class="keyword">for</span> i<span class="symbol">.</span>
    oldTotal <span class="symbol">=</span> get total
    total <span class="symbol">:=</span> oldTotal <span class="symbol">+</span> xs<span class="symbol">.</span>i
    oldTotal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Automatic differentiation</h2>
</div></div><div class="cell"><div class="prose-block"><h3>AD operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: add vector space constraints
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linearize {a b} (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> a <span class="symbol">--</span>o b) <span class="symbol">=</span> %linearize (<span class="symbol">\</span>x<span class="symbol">.</span> f x) x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> jvp {a b} (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">--</span>o b <span class="symbol">=</span> snd (linearize f x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transpose_linear {a b} (f<span class="command">:a</span> <span class="symbol">--</span>o b) <span class="symbol">:</span> b <span class="symbol">--</span>o a <span class="symbol">=</span>
  f&#39; <span class="symbol">:</span> a <span class="symbol">--</span>o b <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> f x
  %linearTranspose f&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vjp {a b} (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> b <span class="symbol">--</span>o a) <span class="symbol">=</span>
  (y<span class="symbol">,</span> df) <span class="symbol">=</span> linearize f x
  (y<span class="symbol">,</span> transpose_linear df)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> grad {a} (f<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deriv (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> jvp f x 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deriv_rev (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- XXX: Watch out when editing this data type! We depend on its structure
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- deep inside the compiler (mostly in linearization and during rule registration).
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">SymbolicTangent</span> a <span class="symbol">=</span>
  <span class="type-name">ZeroTangent</span>
  <span class="type-name">SomeTangent</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> someTangent {a} [<span class="type-name">VSpace</span> a] (x<span class="symbol">:</span><span class="type-name">SymbolicTangent</span> a) <span class="symbol">:</span> a <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">ZeroTangent</span>    <span class="symbol">-&gt;</span> zero
    <span class="type-name">SomeTangent</span> x&#39; <span class="symbol">-&gt;</span> x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Approximate Equality</h3>
<p>TODO: move this outside the AD section to be with equality?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasAllClose</span> a
  allclose <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasDefaultTolerance</span> a
  atol <span class="symbol">:</span> a
  rtol <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">~~</span>) {a} [<span class="type-name">HasAllClose</span> a<span class="symbol">,</span> <span class="type-name">HasDefaultTolerance</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  allclose atol rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span> <span class="type-name">Float32</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol x y<span class="symbol">.</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span> <span class="type-name">Float64</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol x y<span class="symbol">.</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Float32</span>
  atol <span class="symbol">=</span> f_to_f32 0<span class="symbol">.</span>00001
  rtol <span class="symbol">=</span> f_to_f32 0<span class="symbol">.</span>0001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Float64</span>
  atol <span class="symbol">=</span> f_to_f64 0<span class="symbol">.</span>00000001
  rtol <span class="symbol">=</span> f_to_f64 0<span class="symbol">.</span>00001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [ <span class="type-name">HasDefaultTolerance</span> a<span class="symbol">,</span> <span class="type-name">HasDefaultTolerance</span> b
                                         <span class="symbol">,</span> <span class="type-name">HasAllClose</span> a<span class="symbol">,</span> <span class="type-name">HasAllClose</span> b] 
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol (a<span class="symbol">,</span> b) (c<span class="symbol">,</span> d)<span class="symbol">.</span> (a <span class="symbol">~~</span> c) <span class="symbol">&amp;&amp;</span> (b <span class="symbol">~~</span> d)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">HasDefaultTolerance</span> a<span class="symbol">,</span> <span class="type-name">HasDefaultTolerance</span> b]
  atol <span class="symbol">=</span> (atol<span class="symbol">,</span> atol)
  rtol <span class="symbol">=</span> (rtol<span class="symbol">,</span> rtol)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span> (n<span class="symbol">=&gt;</span>t) <span class="keyword">given</span> {n t} [<span class="type-name">HasAllClose</span> t]
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol a b<span class="symbol">.</span>
    all <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> allclose atol<span class="symbol">.</span>i rtol<span class="symbol">.</span>i a<span class="symbol">.</span>i b<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span> (n<span class="symbol">=&gt;</span>t) <span class="keyword">given</span> {n t} [<span class="type-name">HasDefaultTolerance</span> t]
  atol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> atol
  rtol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>AD Checking tools</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> check_deriv_base (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  eps <span class="symbol">=</span> 0<span class="symbol">.</span>01
  ansFwd  <span class="symbol">=</span> deriv    f x
  ansRev  <span class="symbol">=</span> deriv_rev f x
  ansNumeric <span class="symbol">=</span> (f (x <span class="symbol">+</span> eps) <span class="symbol">-</span> f (x <span class="symbol">-</span> eps)) <span class="symbol">/</span> (2<span class="symbol">.</span> <span class="symbol">*</span> eps)
  ansFwd <span class="symbol">~~</span> ansNumeric <span class="symbol">&amp;&amp;</span> ansRev <span class="symbol">~~</span> ansNumeric
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> check_deriv (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  check_deriv_base f x <span class="symbol">&amp;&amp;</span> check_deriv_base (deriv f) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Length-erased lists</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  <span class="type-name">AsList</span> n<span class="symbol">:</span><span class="type-name">Nat</span> elements<span class="symbol">:</span>(<span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> (<span class="type-name">List</span> a) <span class="keyword">given</span> {a} [<span class="type-name">Eq</span> a]
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">AsList</span> nx xs) (<span class="type-name">AsList</span> ny ys)<span class="symbol">.</span>
    <span class="keyword">if</span> nx <span class="symbol">/=</span> ny
      <span class="keyword">then</span> <span class="type-name">False</span>
      <span class="keyword">else</span> all <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nx)<span class="symbol">.</span>
        xs<span class="symbol">.</span>i <span class="symbol">==</span> ys<span class="symbol">.</span>(unsafe_from_ordinal _ (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_cast_table {n a} (m<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> m] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>(unsafe_from_ordinal _ (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> to_list {n a} (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="type-name">AsList</span> _ <span class="symbol">$</span> unsafe_cast_table (<span class="type-name">Fin</span> n&#39;) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span> (<span class="type-name">List</span> a) <span class="keyword">given</span> {a}
  mempty <span class="symbol">=</span> <span class="type-name">AsList</span> _ []
  mcombine <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
    (<span class="type-name">AsList</span> nx xs) <span class="symbol">=</span> x
    (<span class="type-name">AsList</span> ny ys) <span class="symbol">=</span> y
    nz <span class="symbol">=</span> nx <span class="symbol">+</span> ny
    <span class="type-name">AsList</span> _ <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nz)<span class="symbol">.</span>
      i&#39; <span class="symbol">=</span> ordinal i
      <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> nx <span class="keyword">of</span>
        <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs<span class="symbol">.</span>(unsafe_from_ordinal _ i&#39;)
        <span class="type-name">False</span> <span class="symbol">-&gt;</span> ys<span class="symbol">.</span>(unsafe_from_ordinal _ <span class="symbol">$</span> unsafe_nat_diff i&#39; nx)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">ListMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> (<span class="type-name">List</span> a) <span class="keyword">given</span> (a<span class="symbol">:</span><span class="type-name">Type</span>)
  mempty <span class="symbol">=</span> mempty
  mcombine <span class="symbol">=</span> mcombine
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO Eliminate or reimplement this operation, since it costs O(n)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- where n is the length of the list held in the reference.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> append {a h} [<span class="type-name">AccumMonoid</span> h (<span class="type-name">List</span> a)]
  (list<span class="symbol">:</span> <span class="type-name">Ref</span> h (<span class="type-name">List</span> a)) (x<span class="command">:a</span>) <span class="symbol">:</span> {<span class="type-name">Accum</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span>
    list <span class="symbol">+=</span> <span class="type-name">AsList</span> _ [x]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Isomorphisms</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Iso</span> a b <span class="symbol">=</span> <span class="type-name">MkIso</span> { fwd<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">&amp;</span> bwd<span class="symbol">:</span> b <span class="symbol">-&gt;</span> a }
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> app_iso {a b} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (x<span class="command">:a</span>) <span class="symbol">:</span> b <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}) <span class="symbol">=</span> iso
  fwd x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> flip_iso {a b} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) <span class="symbol">:</span> <span class="type-name">Iso</span> b a <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}) <span class="symbol">=</span> iso
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>bwd<span class="symbol">,</span> bwd<span class="symbol">=</span>fwd}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rev_iso {a b} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (x<span class="command">:b</span>) <span class="symbol">:</span> a <span class="symbol">=</span> app_iso (flip_iso iso) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> id_iso {a} <span class="symbol">:</span> <span class="type-name">Iso</span> a a <span class="symbol">=</span> <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>id<span class="symbol">,</span> bwd<span class="symbol">=</span>id}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&gt;&gt;</span>) {a b c} (iso1<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (iso2<span class="symbol">:</span> <span class="type-name">Iso</span> b c) <span class="symbol">:</span> <span class="type-name">Iso</span> a c <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>fwd1<span class="symbol">,</span> bwd<span class="symbol">=</span>bwd1}) <span class="symbol">=</span> iso1
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>fwd2<span class="symbol">,</span> bwd<span class="symbol">=</span>bwd2}) <span class="symbol">=</span> iso2
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>(fwd1 <span class="symbol">&gt;&gt;&gt;</span> fwd2)<span class="symbol">,</span> bwd<span class="symbol">=</span>(bwd1 <span class="symbol">&lt;&lt;&lt;</span> bwd2)}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&lt;&amp;</span>) {a b c} (iso2<span class="symbol">:</span> <span class="type-name">Iso</span> b c) (iso1<span class="symbol">:</span> <span class="type-name">Iso</span> a b) <span class="symbol">:</span> <span class="type-name">Iso</span> a c <span class="symbol">=</span> iso1 <span class="symbol">&amp;&gt;&gt;</span> iso2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Lens-like accessors</h3>
<p>note: <code>#foo is an Iso {foo: a &amp; ...b} (a &amp; {&amp;...b}))</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get_at  {a b c} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">=</span> fst <span class="symbol">&lt;&lt;&lt;</span> app_iso iso
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> pop_at  {a b c} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> snd <span class="symbol">&lt;&lt;&lt;</span> app_iso iso
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> push_at {a b c} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (x<span class="command">:b</span>) (r<span class="command">:c</span>) <span class="symbol">:</span> a <span class="symbol">=</span> rev_iso iso (x<span class="symbol">,</span> r)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> set_at  {a b c} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (x<span class="command">:b</span>) (r<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  push_at iso x <span class="symbol">$</span> pop_at iso r
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Prism-like accessors</h3>
<p>note: <code>#?foo is an Iso {foo: a | ...b} (a | {|...b}))</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> match_with {a b c} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c)) (x<span class="symbol">:</span> a) <span class="symbol">:</span> <span class="type-name">Maybe</span> b <span class="symbol">=</span>
  <span class="keyword">case</span> app_iso iso x <span class="keyword">of</span>
    <span class="type-name">Left</span> x <span class="symbol">-&gt;</span> <span class="type-name">Just</span> x
    <span class="type-name">Right</span> _ <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> build_with {a b c} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c)) (x<span class="symbol">:</span> b) <span class="symbol">:</span> a <span class="symbol">=</span> rev_iso iso <span class="symbol">$</span> <span class="type-name">Left</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> swap_pair_iso {a b} <span class="symbol">:</span> <span class="type-name">Iso</span> (a <span class="symbol">&amp;</span> b) (b <span class="symbol">&amp;</span> a) <span class="symbol">=</span>
  <span class="type-name">MkIso</span> {fwd <span class="symbol">=</span> <span class="symbol">\</span>(a<span class="symbol">,</span> b)<span class="symbol">.</span> (b<span class="symbol">,</span> a)<span class="symbol">,</span> bwd <span class="symbol">=</span> <span class="symbol">\</span>(b<span class="symbol">,</span> a)<span class="symbol">.</span> (a<span class="symbol">,</span> b)}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Complement lens</h3>
<p>Complement the focus of a lens-like isomorphism</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> except_lens {a b c} (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) <span class="symbol">:</span> <span class="type-name">Iso</span> a (c <span class="symbol">&amp;</span> b) <span class="symbol">=</span> iso <span class="symbol">&amp;&gt;&gt;</span> swap_pair_iso
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> swap_either_iso {a b} <span class="symbol">:</span> <span class="type-name">Iso</span> (a <span class="symbol">|</span> b) (b <span class="symbol">|</span> a) <span class="symbol">=</span>
  fwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span> l <span class="symbol">-&gt;</span> <span class="type-name">Right</span> l
    <span class="type-name">Right</span> r <span class="symbol">-&gt;</span> <span class="type-name">Left</span> r
  bwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span> r <span class="symbol">-&gt;</span> <span class="type-name">Right</span> r
    <span class="type-name">Right</span> l <span class="symbol">-&gt;</span> <span class="type-name">Left</span> l
  <span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Complement prism</h3>
<p>Complement the focus of a prism-like isomorphism</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> except_prism {a b c} <span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c) <span class="symbol">-&gt;</span> <span class="type-name">Iso</span> a (c <span class="symbol">|</span> b) <span class="symbol">=</span> <span class="symbol">\</span>iso<span class="symbol">.</span> iso <span class="symbol">&amp;&gt;&gt;</span> swap_either_iso
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Use a lens-like iso to split a 1d table into a 2d table
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> over_lens {a b c v} [<span class="type-name">Ix</span> b<span class="symbol">,</span> <span class="type-name">Ix</span> c] (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> (b<span class="symbol">=&gt;</span>c<span class="symbol">=&gt;</span>v) <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> tab<span class="symbol">.</span>(rev_iso iso (i<span class="symbol">,</span> j))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Zipper</h3>
<p>Zipper isomorphisms to easily specify many record/variant fields:</p>
<pre><code>#&amp;foo is an Iso ({&amp;...l} &amp; {foo:a &amp; ...r}) ({foo:a &amp; ...l} &amp; {&amp;...r})
#|foo is an Iso ({|...l} | {foo:a | ...r}) ({foo:a | ...l} | {|...r})
</code></pre>
</div></div><div class="cell"><div class="prose-block"><p>Convert a record zipper isomorphism to a normal lens-like isomorphism
by using <code>splitR &amp;&gt;&gt; iso</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> split_r {a} <span class="symbol">:</span> <span class="type-name">Iso</span> a ({<span class="symbol">&amp;</span>} <span class="symbol">&amp;</span> a) <span class="symbol">=</span> <span class="type-name">MkIso</span> {fwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> ({}<span class="symbol">,</span> x)<span class="symbol">,</span> bwd <span class="symbol">=</span> <span class="symbol">\</span>({}<span class="symbol">,</span> x)<span class="symbol">.</span> x}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> over_fields {a b c v} [<span class="type-name">Ix</span> b<span class="symbol">,</span> <span class="type-name">Ix</span> c]
      (iso<span class="symbol">:</span> <span class="type-name">Iso</span> ({<span class="symbol">&amp;</span>} <span class="symbol">&amp;</span> a) (b <span class="symbol">&amp;</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>c<span class="symbol">=&gt;</span>v <span class="symbol">=</span>
  over_lens (split_r <span class="symbol">&amp;&gt;&gt;</span> iso) tab
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Convert a variant zipper isomorphism to a normal prism-like isomorphism
by using <code>splitV &amp;&gt;&gt; iso</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> split_v {a} <span class="symbol">:</span> <span class="type-name">Iso</span> a ({ <span class="symbol">|</span> } <span class="symbol">|</span> a) <span class="symbol">=</span>
  <span class="type-name">MkIso</span> {fwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="type-name">Right</span> x<span class="symbol">,</span> bwd <span class="symbol">=</span> <span class="symbol">\</span>v<span class="symbol">.</span> <span class="keyword">case</span> v <span class="keyword">of</span> <span class="type-name">Right</span> x <span class="symbol">-&gt;</span> x}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> slice_fields {a b c v} [<span class="type-name">Ix</span> b] (iso<span class="symbol">:</span> <span class="type-name">Iso</span> ({ <span class="symbol">|</span> } <span class="symbol">|</span> a) (b <span class="symbol">|</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>v <span class="symbol">=</span>
  reindex (build_with <span class="symbol">$</span> split_v <span class="symbol">&amp;&gt;&gt;</span> iso) tab
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: replace `slice` with this?
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> post_slice {a n} (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Post</span> n) (end<span class="symbol">:</span><span class="type-name">Post</span> n) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  slice_size <span class="symbol">=</span> unsafe_nat_diff (ordinal end) (ordinal start)
  to_list <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> slice_size)<span class="symbol">.</span>
    xs<span class="symbol">.</span>(unsafe_from_ordinal n (ordinal i <span class="symbol">+</span> ordinal start))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Dynamic buffer</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: would be nice to be able to use records here
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">DynBuffer</span> a <span class="symbol">=</span>
  <span class="type-name">MkDynBuffer</span> {
      size    <span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Nat</span>
    <span class="symbol">&amp;</span> maxSize <span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Nat</span>
    <span class="symbol">&amp;</span> buffer  <span class="symbol">:</span> <span class="type-name">Ptr</span> (<span class="type-name">Ptr</span> a) }
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_dynamic_buffer {a b} [<span class="type-name">Storable</span> a]
      (action<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b) <span class="symbol">:</span> {<span class="type-name">IO</span>} b <span class="symbol">=</span>
  initMaxSize <span class="symbol">=</span> 256
  sizePtr <span class="symbol">&lt;-</span> with_alloc 1
  store sizePtr 0
  maxSizePtr <span class="symbol">&lt;-</span> with_alloc 1
  store maxSizePtr initMaxSize
  bufferPtr <span class="symbol">&lt;-</span> with_alloc 1
  store bufferPtr <span class="symbol">$</span> malloc initMaxSize
  result <span class="symbol">=</span> action <span class="symbol">$</span> <span class="type-name">MkDynBuffer</span> {
      size    <span class="symbol">=</span> sizePtr
    <span class="symbol">,</span> maxSize <span class="symbol">=</span> maxSizePtr
    <span class="symbol">,</span> buffer  <span class="symbol">=</span> bufferPtr }
  free <span class="symbol">$</span> load bufferPtr
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maybe_increase_buffer_size {a} [<span class="type-name">Storable</span> a]
      ((<span class="type-name">MkDynBuffer</span> db)<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) (sizeDelta<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  size    <span class="symbol">=</span> load <span class="symbol">$</span> get_at <span class="iso-sugar">#size</span>    db
  maxSize <span class="symbol">=</span> load <span class="symbol">$</span> get_at <span class="iso-sugar">#maxSize</span> db
  bufPtr  <span class="symbol">=</span> load <span class="symbol">$</span> get_at <span class="iso-sugar">#buffer</span>  db
  newSize <span class="symbol">=</span> sizeDelta <span class="symbol">+</span> size
  <span class="keyword">if</span> newSize <span class="symbol">&gt;</span> maxSize <span class="keyword">then</span>
    <span class="comment">-- TODO: maybe this should use integer arithmetic?
</span>    newMaxSize <span class="symbol">=</span> f_to_n <span class="symbol">$</span> pow 2<span class="symbol">.</span>0 (ceil <span class="symbol">$</span> log2 <span class="symbol">$</span> n_to_f newSize)
    newBufPtr <span class="symbol">=</span> malloc newMaxSize
    memcpy newBufPtr bufPtr size
    free bufPtr
    store (get_at <span class="iso-sugar">#maxSize</span> db) newMaxSize
    store (get_at <span class="iso-sugar">#buffer</span>  db) newBufPtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> add_at_nat_ptr (ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Nat</span>) (n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  store ptr (load ptr <span class="symbol">+</span> n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> extend_dynamic_buffer {a} [<span class="type-name">Storable</span> a]
      (buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) (new<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">AsList</span> n xs) <span class="symbol">=</span> new
  maybe_increase_buffer_size buf n
  (<span class="type-name">MkDynBuffer</span> db) <span class="symbol">=</span> buf
  bufPtr <span class="symbol">=</span> load <span class="symbol">$</span> get_at <span class="iso-sugar">#buffer</span> db
  size   <span class="symbol">=</span> load <span class="symbol">$</span> get_at <span class="iso-sugar">#size</span> db
  store_table (bufPtr <span class="symbol">+&gt;&gt;</span> size) xs
  add_at_nat_ptr (get_at <span class="iso-sugar">#size</span> db) n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> load_dynamic_buffer {a} [<span class="type-name">Storable</span> a]
      (buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">List</span> a) <span class="symbol">=</span>
  (<span class="type-name">MkDynBuffer</span> db) <span class="symbol">=</span> buf
  bufPtr <span class="symbol">=</span> load <span class="symbol">$</span> get_at <span class="iso-sugar">#buffer</span> db
  size   <span class="symbol">=</span> load <span class="symbol">$</span> get_at <span class="iso-sugar">#size</span> db
  <span class="type-name">AsList</span> size <span class="symbol">$</span> table_from_ptr _ bufPtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> push_dynamic_buffer {a} [<span class="type-name">Storable</span> a]
      (buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) (x<span class="command">:a</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  extend_dynamic_buffer buf <span class="symbol">$</span> <span class="type-name">AsList</span> _ [x]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Strings and Characters</h2>
</div></div><div class="cell"><div class="code-block"><span class="type-name">String</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">List</span> <span class="type-name">Char</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> string_from_char_ptr (n<span class="symbol">:</span><span class="type-name">Word32</span>) (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  <span class="type-name">AsList</span> (rep_to_nat n) <span class="symbol">$</span> table_from_ptr _ ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO. This is ASCII code point. It really should be Int32 for Unicode codepoint
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> codepoint (c<span class="symbol">:</span><span class="type-name">Char</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> w8_to_i c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">CString</span> <span class="symbol">=</span> <span class="type-name">MkCString</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: check the string contains no nulls
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_c_string {a} (s<span class="symbol">:</span><span class="type-name">String</span>) (action<span class="symbol">:</span> <span class="type-name">CString</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  (<span class="type-name">AsList</span> n s&#39;) <span class="symbol">=</span> s <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">\</span><span class="type-name">NUL</span>&quot;
  with_table_ptr s&#39; <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)<span class="symbol">.</span> action <span class="symbol">$</span> <span class="type-name">MkCString</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Show interface</h3>
<p>For things that can be shown.
<code>show</code> gives a string representation of its input.
No particular promises are made to exactly what that representation will contain.
In particular it is <strong>not</strong> promised to be parseable.
Nor does it promise a particular level of precision for numeric values.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Show</span> a
  show <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">String</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">String</span>
  show <span class="symbol">=</span> id
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showInt32&quot; showInt32 <span class="symbol">:</span> <span class="type-name">Int32</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Int32</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafe_io <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showInt32 x
    string_from_char_ptr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showInt64&quot; showInt64 <span class="symbol">:</span> <span class="type-name">Int64</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Int64</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafe_io <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showInt64 x
    string_from_char_ptr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Nat</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> show <span class="symbol">$</span> n_to_i64 x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showFloat32&quot; showFloat32 <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Float32</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafe_io <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showFloat32 x
    string_from_char_ptr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showFloat64&quot; showFloat64 <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Float64</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafe_io <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showFloat64 x
    string_from_char_ptr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Show</span> a<span class="symbol">,</span> <span class="type-name">Show</span> b]
  show <span class="symbol">=</span> <span class="symbol">\</span>(a<span class="symbol">,</span> b)<span class="symbol">.</span> &quot;(&quot; <span class="symbol">&lt;&gt;</span> show a <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show b <span class="symbol">&lt;&gt;</span> &quot;)&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Parse interface</h3>
<p>For types that can be parsed from a <code>String</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Parse</span> a
  parseString <span class="symbol">:</span> <span class="type-name">String</span> <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;strtof&quot; strtofFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Float</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Parse</span> <span class="type-name">Float</span>
  parseString <span class="symbol">=</span> <span class="symbol">\</span>str<span class="symbol">.</span> unsafe_io <span class="keyword">do</span>
    (<span class="type-name">AsList</span> str_len _) <span class="symbol">=</span> str
    with_c_string str <span class="symbol">\</span>(<span class="type-name">MkCString</span> str_ptr)<span class="symbol">.</span>
      with_alloc 1 <span class="symbol">\</span>end_ptr<span class="symbol">:</span>(<span class="type-name">Ptr</span> (<span class="type-name">Ptr</span> <span class="type-name">Char</span>))<span class="symbol">.</span>
        (<span class="type-name">MkPtr</span> raw_end_ptr) <span class="symbol">=</span> end_ptr
        result <span class="symbol">=</span> strtofFFI str_ptr raw_end_ptr
        (<span class="type-name">MkPtr</span> str_end_ptr) <span class="symbol">=</span> load end_ptr
        consumed <span class="symbol">=</span> raw_ptr_to_i64 str_end_ptr <span class="symbol">-</span> raw_ptr_to_i64 str_ptr
        <span class="keyword">if</span> consumed <span class="symbol">==</span> (n_to_i64 str_len) <span class="keyword">then</span> <span class="type-name">Just</span> result <span class="keyword">else</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>pipe-like reverse function application</h2>
<p>TODO: move this</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">|&gt;</span>) {a b} (x<span class="command">:a</span>) (f<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) <span class="symbol">:</span> b <span class="symbol">=</span> f x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Floating-point helper functions</h2>
<p>TODO: Move these to be with Elementary/Special functions. Or move those to be here.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sign (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> 1<span class="symbol">.</span>0
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="symbol">-</span>1<span class="symbol">.</span>0
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> copysign (a<span class="symbol">:</span><span class="type-name">Float</span>) (b<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> b <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> a
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> b <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> (<span class="symbol">-</span>a)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block">infinity <span class="symbol">=</span> 1<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">nan      <span class="symbol">=</span> 0<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isinf (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (x <span class="symbol">==</span> infinity) <span class="symbol">||</span> (x <span class="symbol">==</span> <span class="symbol">-</span>infinity)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isnan (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not (x <span class="symbol">&gt;=</span> x <span class="symbol">&amp;&amp;</span> x <span class="symbol">&lt;=</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE-754R 5.11: Floating Point Comparison Relation cmpUnordered.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> either_is_nan (x<span class="symbol">:</span><span class="type-name">Float</span>) (y<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (isnan x) <span class="symbol">||</span> (isnan y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>File system operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="type-name">FilePath</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">String</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_null_raw_ptr (ptr<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  raw_ptr_to_i64 ptr <span class="symbol">==</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_nullable_raw_ptr {a} (ptr<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> (<span class="type-name">Ptr</span> a) <span class="symbol">=</span>
  <span class="keyword">if</span> is_null_raw_ptr ptr
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> c_string_ptr (s<span class="symbol">:</span><span class="type-name">CString</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> (<span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">=</span>
  (<span class="type-name">MkCString</span> ptr) <span class="symbol">=</span> s
  from_nullable_raw_ptr ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">StreamMode</span> <span class="symbol">=</span>
  <span class="type-name">ReadMode</span>
  <span class="type-name">WriteMode</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Stream</span> mode<span class="symbol">:</span><span class="type-name">StreamMode</span> <span class="symbol">=</span> <span class="type-name">MkStream</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Stream IO</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fopen&quot; fopenFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fclose&quot; fcloseFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fwrite&quot; fwriteFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> <span class="type-name">Int64</span> <span class="symbol">-&gt;</span> <span class="type-name">Int64</span> <span class="symbol">-&gt;</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fread&quot;  freadFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> <span class="type-name">Int64</span> <span class="symbol">-&gt;</span> <span class="type-name">Int64</span> <span class="symbol">-&gt;</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fflush&quot; fflushFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fopen (path<span class="symbol">:</span><span class="type-name">String</span>) (mode<span class="symbol">:</span><span class="type-name">StreamMode</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">Stream</span> mode) <span class="symbol">=</span>
  modeStr <span class="symbol">=</span> <span class="keyword">case</span> mode <span class="keyword">of</span>
    <span class="type-name">ReadMode</span>  <span class="symbol">-&gt;</span> &quot;r&quot;
    <span class="type-name">WriteMode</span> <span class="symbol">-&gt;</span> &quot;w&quot;
  with_c_string path <span class="symbol">\</span>(<span class="type-name">MkCString</span> pathPtr)<span class="symbol">.</span>
    with_c_string modeStr <span class="symbol">\</span>(<span class="type-name">MkCString</span> modePtr)<span class="symbol">.</span>
      <span class="type-name">MkStream</span> <span class="symbol">$</span> fopenFFI pathPtr modePtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fclose {mode} (stream<span class="symbol">:</span><span class="type-name">Stream</span> mode) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  fcloseFFI stream&#39;
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fwrite (stream<span class="symbol">:</span><span class="type-name">Stream</span> <span class="type-name">WriteMode</span>) (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  (<span class="type-name">AsList</span> n s&#39;) <span class="symbol">=</span> s
  with_table_ptr s&#39; <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)<span class="symbol">.</span>
    fwriteFFI ptr (i_to_i64 1) (n_to_i64 n) stream&#39;
  fflushFFI stream&#39;
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Iteration</h3>
<p>TODO: move this out of the file-system section</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> while {eff} (body<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Bool</span>) <span class="symbol">:</span> {<span class="symbol">|</span>eff} <span class="type-name">Unit</span> <span class="symbol">=</span>
  body&#39; <span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Word8</span> <span class="symbol">=</span> <span class="symbol">\</span>_<span class="symbol">.</span> b_to_w8 <span class="symbol">$</span> body ()
  %while body&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">IterResult</span> a <span class="symbol">=</span>
  <span class="type-name">Continue</span>
  <span class="type-name">Done</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: can we improve effect inference so we don&#39;t need this?
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lift_state {a b c h eff} (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h c) (f<span class="command">:a</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} b) (x<span class="command">:a</span>) <span class="symbol">:</span> {<span class="type-name">State</span> h<span class="symbol">|</span>eff} b <span class="symbol">=</span>
  f x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- A little iteration combinator
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iter {a eff} (body<span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">IterResult</span> a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} a  <span class="symbol">=</span>
  result <span class="symbol">=</span> yield_state <span class="type-name">Nothing</span> <span class="symbol">\</span>resultRef<span class="symbol">.</span>
    i <span class="symbol">&lt;-</span> with_state 0
    while <span class="keyword">do</span>
      continue <span class="symbol">=</span> is_nothing <span class="symbol">$</span> get resultRef
      <span class="keyword">if</span> continue <span class="keyword">then</span>
        <span class="keyword">case</span> lift_state resultRef (lift_state i body) (get i) <span class="keyword">of</span>
          <span class="type-name">Continue</span> <span class="symbol">-&gt;</span> i <span class="symbol">:=</span> get i <span class="symbol">+</span> 1
          <span class="type-name">Done</span> result <span class="symbol">-&gt;</span> resultRef <span class="symbol">:=</span> <span class="type-name">Just</span> result
      continue
  <span class="keyword">case</span> result <span class="keyword">of</span>
    <span class="type-name">Just</span> ans <span class="symbol">-&gt;</span> ans
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> unreachable ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> bounded_iter {a eff}
      (maxIters<span class="symbol">:</span><span class="type-name">Nat</span>) (fallback<span class="command">:a</span>)
      (body<span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">IterResult</span> a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} a  <span class="symbol">=</span>
  iter <span class="symbol">\</span>i<span class="symbol">.</span>
    <span class="keyword">if</span> i <span class="symbol">&gt;=</span> maxIters
      <span class="keyword">then</span> <span class="type-name">Done</span> fallback
      <span class="keyword">else</span> body i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Environment Variables</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_c_string (s<span class="symbol">:</span><span class="type-name">CString</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">Maybe</span> <span class="type-name">String</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> c_string_ptr s <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Just</span> ptr <span class="symbol">-&gt;</span>
      <span class="type-name">Just</span> <span class="symbol">$</span> with_dynamic_buffer <span class="symbol">\</span>buf<span class="symbol">.</span> iter <span class="symbol">\</span>i<span class="symbol">.</span>
        c <span class="symbol">=</span> load <span class="symbol">$</span> ptr <span class="symbol">+&gt;&gt;</span> i
        <span class="keyword">if</span> c <span class="symbol">==</span> &#39;<span class="symbol">\</span><span class="type-name">NUL</span>&#39;
          <span class="keyword">then</span> <span class="type-name">Done</span> <span class="symbol">$</span> load_dynamic_buffer buf
          <span class="keyword">else</span>
            push_dynamic_buffer buf c
            <span class="type-name">Continue</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;getenv&quot; getenvFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get_env (name<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Maybe</span> <span class="type-name">String</span> <span class="symbol">=</span>
  with_c_string name <span class="symbol">\</span>(<span class="type-name">MkCString</span> ptr)<span class="symbol">.</span>
    from_c_string <span class="symbol">$</span> <span class="type-name">MkCString</span> <span class="symbol">$</span> getenvFFI ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> check_env (name<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Bool</span> <span class="symbol">=</span>
  is_just <span class="symbol">$</span> get_env name
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>More Stream IO</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fread (stream<span class="symbol">:</span><span class="type-name">Stream</span> <span class="type-name">ReadMode</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  <span class="comment">-- TODO: allow reading longer files!
</span>  n <span class="symbol">=</span> 4096
  ptr<span class="symbol">:</span>(<span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">&lt;-</span> with_alloc n
  buf <span class="symbol">&lt;-</span> with_dynamic_buffer
  iter <span class="symbol">\</span>_<span class="symbol">.</span>
    (<span class="type-name">MkPtr</span> rawPtr) <span class="symbol">=</span> ptr
    numRead <span class="symbol">=</span> i_to_w32 <span class="symbol">$</span> i64_to_i <span class="symbol">$</span> freadFFI rawPtr (i_to_i64 1) (n_to_i64 n) stream&#39;
    extend_dynamic_buffer buf <span class="symbol">$</span> string_from_char_ptr numRead ptr
    <span class="keyword">if</span> numRead <span class="symbol">==</span> n_to_w32 n
      <span class="keyword">then</span> <span class="type-name">Continue</span>
      <span class="keyword">else</span> <span class="type-name">Done</span> ()
  load_dynamic_buffer buf
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Print</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get_output_stream (_<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Stream</span> <span class="type-name">WriteMode</span> <span class="symbol">=</span>
  <span class="type-name">MkStream</span> <span class="symbol">$</span> %outputStream
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> print (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  stream <span class="symbol">=</span> get_output_stream ()
  fwrite stream s
  fwrite stream &quot;<span class="symbol">\</span>n&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Shelling Out</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;popen&quot; popenFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;remove&quot; removeFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;mkstemp&quot; mkstempFFI <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;close&quot; closeFFI <span class="symbol">:</span> <span class="type-name">Int32</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> shell_out (command<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  modeStr <span class="symbol">=</span> &quot;r&quot;
  with_c_string command <span class="symbol">\</span>(<span class="type-name">MkCString</span> commandPtr)<span class="symbol">.</span>
    with_c_string modeStr <span class="symbol">\</span>(<span class="type-name">MkCString</span> modePtr)<span class="symbol">.</span>
      pipe <span class="symbol">=</span> <span class="type-name">MkStream</span> <span class="symbol">$</span> popenFFI commandPtr modePtr
      fread pipe
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Partial functions</h2>
<p>A partial function in this context is a function that can error.
i.e. a function that is not actually defined for all of its supposed domain.
Not to be confused with a partially applied function</p>
</div></div><div class="cell"><div class="prose-block"><h3>Error throwing</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> error {a} (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> a <span class="symbol">=</span> unsafe_io <span class="keyword">do</span>
  print s
  %throwError a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> todo {a} <span class="symbol">:</span> a <span class="symbol">=</span> error &quot;<span class="type-name">TODO</span><span class="symbol">:</span> implement it<span class="symbol">!</span>&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>File Operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> delete_file (f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  with_c_string f <span class="symbol">\</span>(<span class="type-name">MkCString</span> ptr)<span class="symbol">.</span>
    removeFFI ptr
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_file {a}
      (f<span class="symbol">:</span><span class="type-name">FilePath</span>) (mode<span class="symbol">:</span><span class="type-name">StreamMode</span>)
      (action<span class="symbol">:</span> <span class="type-name">Stream</span> mode <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a)
      <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  stream <span class="symbol">=</span> fopen f mode
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  <span class="keyword">if</span> is_null_raw_ptr stream&#39;
    <span class="keyword">then</span>
      error <span class="symbol">$</span> &quot;<span class="type-name">Unable</span> to open file<span class="symbol">:</span> &quot; <span class="symbol">&lt;&gt;</span> f
    <span class="keyword">else</span>
      result <span class="symbol">=</span> action stream
      fclose stream
      result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> write_file (f<span class="symbol">:</span><span class="type-name">FilePath</span>) (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  with_file f <span class="type-name">WriteMode</span> <span class="symbol">\</span>stream<span class="symbol">.</span> fwrite stream s
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> read_file (f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  with_file f <span class="type-name">ReadMode</span> <span class="symbol">\</span>stream<span class="symbol">.</span> fread stream
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> has_file (f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Bool</span> <span class="symbol">=</span>
  stream <span class="symbol">=</span> fopen f <span class="type-name">ReadMode</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  result <span class="symbol">=</span> not (is_null_raw_ptr stream&#39;)
  <span class="keyword">if</span> result <span class="keyword">then</span> fclose stream
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Temporary Files</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> new_temp_file (_<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">FilePath</span> <span class="symbol">=</span>
  with_c_string &quot;<span class="symbol">/</span>tmp<span class="symbol">/</span>dex<span class="symbol">-</span><span class="type-name">XXXXXX</span>&quot; <span class="symbol">\</span>(<span class="type-name">MkCString</span> ptr)<span class="symbol">.</span>
    fd <span class="symbol">=</span> mkstempFFI ptr
    closeFFI fd
    string_from_char_ptr 15 (<span class="type-name">MkPtr</span> ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_temp_file {a} (action<span class="symbol">:</span> <span class="type-name">FilePath</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  tmpFile <span class="symbol">=</span> new_temp_file ()
  result <span class="symbol">=</span> action tmpFile
  delete_file tmpFile
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_temp_files {n a} [<span class="type-name">Ix</span> n] (action<span class="symbol">:</span> (n<span class="symbol">=&gt;</span><span class="type-name">FilePath</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  tmpFiles <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> new_temp_file ()
  result <span class="symbol">=</span> action tmpFiles
  <span class="keyword">for</span> i<span class="symbol">.</span> delete_file tmpFiles<span class="symbol">.</span>i
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Table operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> from_ordinal_error (i<span class="symbol">:</span><span class="type-name">Nat</span>) (upper<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">String</span> <span class="symbol">=</span>
  &quot;<span class="type-name">Ordinal</span> index out <span class="keyword">of</span> range<span class="symbol">:</span>&quot; <span class="symbol">&lt;&gt;</span> show i <span class="symbol">&lt;&gt;</span> &quot; <span class="symbol">&gt;=</span> &quot; <span class="symbol">&lt;&gt;</span> show upper
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_ordinal (n<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> n] (i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  <span class="keyword">case</span> (0 <span class="symbol">&lt;=</span> i) <span class="symbol">&amp;&amp;</span> (i <span class="symbol">&lt;</span> size n) <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> unsafe_from_ordinal _ i
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> error <span class="symbol">$</span> from_ordinal_error i <span class="symbol">$</span> size n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: could make an `unsafeCastIndex` and this could avoid the runtime copy
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: safe (runtime-checked) and unsafe versions
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cast_table {n a} (m<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> m] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">case</span> size m <span class="symbol">==</span> size n <span class="keyword">of</span>
     <span class="type-name">True</span>  <span class="symbol">-&gt;</span> unsafe_cast_table _ xs
     <span class="type-name">False</span> <span class="symbol">-&gt;</span> error <span class="symbol">$</span>
       &quot;<span class="type-name">Table</span> size mismatch in cast<span class="symbol">:</span> &quot; <span class="symbol">&lt;&gt;</span> show (size m) <span class="symbol">&lt;&gt;</span> &quot; vs &quot; <span class="symbol">&lt;&gt;</span> show (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> asidx {n} [<span class="type-name">Ix</span> n] (i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> n <span class="symbol">=</span> from_ordinal n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">@</span>) (i<span class="symbol">:</span><span class="type-name">Nat</span>) (n<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> n] <span class="symbol">:</span> n <span class="symbol">=</span> from_ordinal n i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> slice {n a} (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Nat</span>) (m<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> m] <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>(from_ordinal _ (ordinal i <span class="symbol">+</span> start))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> head {n a} (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span> xs<span class="symbol">.</span>(0<span class="symbol">@</span>_)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tail {n a} (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  numElts <span class="symbol">=</span> size n <span class="symbol">-|</span> start
  to_list <span class="symbol">$</span> slice xs start (<span class="type-name">Fin</span> numElts)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Pseudorandom number generator utilities</h2>
<p>Dex does not use a stateful random number generator.
Rather it uses what is known as a split-able random number generator, which is based on a hash function.
Dex's PRNG system is modelled directly after <a href="https://github.com/google/jax/blob/master/design_notes/prng.md">JAX's</a>, which is based on a well established but shockingly underused idea from the functional programming community: the splittable PRNG. It's a good idea for many reasons, but it's especially helpful in a parallel setting. If you want to read more, <a href="http://publications.lib.chalmers.se/records/fulltext/183348/local_183348.pdf">Splittable pseudorandom number generators using cryptographic hashing</a> describes the splitting model itself and <a href="http://www.thesalmons.org/john/random123/papers/random123sc11.pdf">D.E. Shaw Research's counter-based PRNG</a> proposes the particular hash function we use.</p>
</div></div><div class="cell"><div class="prose-block"><h3>Key functions</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: newtype
</span></div></div><div class="cell"><div class="code-block"><span class="type-name">Key</span> <span class="symbol">=</span> <span class="type-name">Word64</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> threefry_2x32 (k<span class="symbol">:</span><span class="type-name">Word64</span>) (count<span class="symbol">:</span><span class="type-name">Word64</span>) <span class="symbol">:</span> <span class="type-name">Word64</span> <span class="symbol">=</span>
  <span class="comment">-- Based on jax&#39;s threefry_2x32 by Matt Johnson and Peter Hawkins
</span>  rotations1 <span class="symbol">=</span> [13<span class="symbol">,</span> 15<span class="symbol">,</span> 26<span class="symbol">,</span> 6]
  rotations2 <span class="symbol">=</span> [17<span class="symbol">,</span> 29<span class="symbol">,</span> 16<span class="symbol">,</span> 24]

  k0 <span class="symbol">=</span> low_word k
  k1 <span class="symbol">=</span> high_word k
  <span class="comment">-- TODO: add a fromHex
</span>  k2 <span class="symbol">=</span> k0 <span class="symbol">.^.</span> k1 <span class="symbol">.^.</span> (n_to_w32 466688986) <span class="comment">-- 0x1BD11BDA
</span>
  x <span class="symbol">=</span> low_word count
  y <span class="symbol">=</span> high_word count
  x <span class="symbol">=</span> x <span class="symbol">+</span> k0
  y <span class="symbol">=</span> y <span class="symbol">+</span> k1

  rotations <span class="symbol">=</span> [rotations1<span class="symbol">,</span> rotations2]
  ks <span class="symbol">=</span> [k1<span class="symbol">,</span> k2<span class="symbol">,</span> k0]
  (x<span class="symbol">,</span> y) <span class="symbol">=</span> yield_state (x<span class="symbol">,</span> y) <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> 5)<span class="symbol">.</span>
    <span class="keyword">for</span> j<span class="symbol">.</span>
      (x<span class="symbol">,</span> y) <span class="symbol">=</span> get ref
      rotationIndex <span class="symbol">=</span> unsafe_from_ordinal _ (mod (ordinal i) 2)
      rot <span class="symbol">=</span> rotations<span class="symbol">.</span>rotationIndex<span class="symbol">.</span>j
      x <span class="symbol">=</span> x <span class="symbol">+</span> y
      y <span class="symbol">=</span> (y <span class="symbol">.&lt;&lt;.</span> rot) <span class="symbol">.|.</span> (y <span class="symbol">.&gt;&gt;.</span> (32 <span class="symbol">-</span> rot))
      y <span class="symbol">=</span> x <span class="symbol">.^.</span> y
      ref <span class="symbol">:=</span> (x<span class="symbol">,</span> y)
    (x<span class="symbol">,</span> y) <span class="symbol">=</span> get ref
    x <span class="symbol">=</span> x <span class="symbol">+</span> ks<span class="symbol">.</span>(unsafe_from_ordinal _ (mod (ordinal i) 3))
    y <span class="symbol">=</span> y <span class="symbol">+</span> ks<span class="symbol">.</span>(unsafe_from_ordinal _ (mod ((ordinal i)<span class="symbol">+</span>1) 3)) <span class="symbol">+</span> n_to_w32 ((ordinal i)<span class="symbol">+</span>1)
    ref <span class="symbol">:=</span> (x<span class="symbol">,</span> y)

  (w32_to_w64 x <span class="symbol">.&lt;&lt;.</span> 32) <span class="symbol">.|.</span> (w32_to_w64 y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> hash (x<span class="symbol">:</span><span class="type-name">Key</span>) (y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span>
  y64 <span class="symbol">=</span> n_to_w64 y
  threefry_2x32 x y64
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> new_key (x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash (n_to_w64 0) x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> many {a n} [<span class="type-name">Ix</span> n] (f<span class="symbol">:</span><span class="type-name">Key</span><span class="symbol">-&gt;</span>a) (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) <span class="symbol">:</span> a <span class="symbol">=</span> f (hash k (ordinal i))
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey {n} (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) [<span class="type-name">Ix</span> n] <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash k (ordinal i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> split_key {n} (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Key</span> <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> ixkey k i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Sample Generators</h3>
<p>These functions generate samples taken from, different distributions.
Such as <code>rand_mat</code> with samples from the distribution of floating point matrices where each element is taken from a i.i.d. uniform distribution. Note that additional standard distributions are provided by the <code>stats</code> library.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  exponent_bits <span class="symbol">=</span> 1065353216 <span class="comment">-- 1065353216 = 127 &lt;&lt; 23
</span>  mantissa_bits <span class="symbol">=</span> (high_word k <span class="symbol">.&amp;.</span> 8388607)  <span class="comment">-- 8388607 == (1 &lt;&lt; 23) - 1
</span>  bits <span class="symbol">=</span> exponent_bits <span class="symbol">.|.</span> mantissa_bits
  (%bitcast <span class="type-name">Float</span> bits) <span class="symbol">-</span> 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_vec {a} (n<span class="symbol">:</span><span class="type-name">Nat</span>) (f<span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a) (k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span> f (ixkey k i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_mat {a} (n<span class="symbol">:</span><span class="type-name">Nat</span>) (m<span class="symbol">:</span><span class="type-name">Nat</span>) (f<span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a) (k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Fin</span> m <span class="symbol">=&gt;</span> a <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> f (ixkey k (i<span class="symbol">,</span> j))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randn (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> split_key k
  <span class="comment">-- rand is uniform between 0 and 1, but implemented such that it rounds to 0
</span>  <span class="comment">-- (in float32) once every few million draws, but never rounds to 1.
</span>  u1 <span class="symbol">=</span> 1<span class="symbol">.</span>0 <span class="symbol">-</span> (rand k1)
  u2 <span class="symbol">=</span> rand k2
  sqrt ((<span class="symbol">-</span>2<span class="symbol">.</span>0) <span class="symbol">*</span> log u1) <span class="symbol">*</span> cos (2<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">*</span> u2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Make this better...
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_int (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> (internal_cast <span class="type-name">Nat</span> k) `mod` 2147483647
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> bern (p<span class="symbol">:</span><span class="type-name">Float</span>) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rand k <span class="symbol">&lt;</span> p
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randn_vec {n} [<span class="type-name">Ix</span> n] (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> randn (ixkey k i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_idx {n} [<span class="type-name">Ix</span> n] (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  unif <span class="symbol">=</span> rand k
  unsafe_from_ordinal n <span class="symbol">$</span> f_to_n <span class="symbol">$</span> floor <span class="symbol">$</span> unif <span class="symbol">*</span> n_to_f (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Inner product typeclass</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> [<span class="type-name">VSpace</span> v] <span class="type-name">InnerProd</span> v
  inner_prod <span class="symbol">:</span> v<span class="symbol">-&gt;</span>v<span class="symbol">-&gt;</span><span class="type-name">Float</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">InnerProd</span> <span class="type-name">Float</span>
  inner_prod <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> x <span class="symbol">*</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">InnerProd</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {a n} [<span class="type-name">InnerProd</span> a]
  inner_prod <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> inner_prod x<span class="symbol">.</span>i y<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Arbitrary</h2>
<p>Type class for generating example values</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Arbitrary</span> a
  arb <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> <span class="type-name">Bool</span>
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span> key <span class="symbol">.&amp;.</span> 1 <span class="symbol">==</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> <span class="type-name">Float32</span>
  arb <span class="symbol">=</span> randn
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> <span class="type-name">Int32</span>
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span> f_to_i <span class="symbol">$</span> randn key <span class="symbol">*</span> 5<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> <span class="type-name">Nat</span>
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span> f_to_n <span class="symbol">$</span> randn key <span class="symbol">*</span> 5<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> {n a} [<span class="type-name">Arbitrary</span> a]
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> ixkey key i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> ((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {n a} [<span class="type-name">Arbitrary</span> a]
  arb <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> new_key (ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> ((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {n a} [<span class="type-name">Arbitrary</span> a]
  arb <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> new_key (ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> ((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {n a} [<span class="type-name">Arbitrary</span> a]
  arb <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> new_key (ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> ((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> {n a} [<span class="type-name">Arbitrary</span> a]
  arb <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> new_key (ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> (a <span class="symbol">&amp;</span> b) <span class="keyword">given</span> {a b} [<span class="type-name">Arbitrary</span> a<span class="symbol">,</span> <span class="type-name">Arbitrary</span> b]
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span>
    [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> split_key key
    (arb k1<span class="symbol">,</span> arb k2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> (<span class="type-name">Fin</span> n) <span class="keyword">given</span> {n}
  arb <span class="symbol">=</span> rand_idx
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Ord on Arrays</h2>
</div></div><div class="cell"><div class="prose-block"><h3>Searching</h3>
</div></div><div class="cell"><div class="prose-block"><p>returns the highest index <code>i</code> such that <code>xs.i &lt;= x</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> search_sorted {n a} [<span class="type-name">Ord</span> a] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (x<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> n <span class="symbol">=</span>
  <span class="keyword">if</span> size n <span class="symbol">==</span> 0
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="keyword">if</span> x <span class="symbol">&lt;</span> xs<span class="symbol">.</span>(from_ordinal _ 0)
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> with_state 0 <span class="symbol">\</span>low<span class="symbol">.</span> with_state (size n) <span class="symbol">\</span>high<span class="symbol">.</span> iter <span class="symbol">\</span>_<span class="symbol">.</span>
        numLeft <span class="symbol">=</span> n_to_i (get high) <span class="symbol">-</span> n_to_i (get low)
        <span class="keyword">if</span> numLeft <span class="symbol">==</span> 1
          <span class="keyword">then</span> <span class="type-name">Done</span> <span class="symbol">$</span> <span class="type-name">Just</span> <span class="symbol">$</span> from_ordinal _ <span class="symbol">$</span> get low
          <span class="keyword">else</span>
            centerIx <span class="symbol">=</span> get low <span class="symbol">+</span> unsafe_i_to_n (idiv numLeft 2)
            <span class="keyword">if</span> x <span class="symbol">&lt;</span> xs<span class="symbol">.</span>(from_ordinal _ centerIx)
              <span class="keyword">then</span> high <span class="symbol">:=</span> centerIx
              <span class="keyword">else</span> low  <span class="symbol">:=</span> centerIx
            <span class="type-name">Continue</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>min / max etc</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min_by {a o} [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&lt;</span> f y) x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> max_by {a o} [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&gt;</span> f y) x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min {o} [<span class="type-name">Ord</span> o] (x1<span class="symbol">:</span> o) (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> min_by id x1 x2
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> max {o} [<span class="type-name">Ord</span> o] (x1<span class="symbol">:</span> o) (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> max_by id x1 x2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimum_by {a n o} [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (min_by f) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximum_by {a n o} [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (max_by f) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimum {n o} [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> minimum_by id xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximum {n o} [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> maximum_by id xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>argmin/argmax</h3>
<p>TODO: put in same section as <code>searchsorted</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argscan {n o} (comp<span class="command">:o</span><span class="symbol">-&gt;</span>o<span class="symbol">-&gt;</span><span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span>
  zeroth <span class="symbol">=</span> (0<span class="symbol">@</span>_<span class="symbol">,</span> xs<span class="symbol">.</span>(0<span class="symbol">@</span>_))
  compare <span class="symbol">=</span> <span class="symbol">\</span>(idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)<span class="symbol">.</span>
    select (comp x1 x2) (idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)
  zipped <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (i<span class="symbol">,</span> xs<span class="symbol">.</span>i)
  fst <span class="symbol">$</span> reduce zeroth compare zipped
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmin {n o} [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span> argscan (<span class="symbol">&lt;</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmax {n o} [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span> argscan (<span class="symbol">&gt;</span>) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lexical_order {n} [<span class="type-name">Ord</span> n]
      (compareElements<span class="command">:n</span><span class="symbol">-&gt;</span>n<span class="symbol">-&gt;</span><span class="type-name">Bool</span>)
      (compareLengths<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">-&gt;</span><span class="type-name">Nat</span><span class="symbol">-&gt;</span><span class="type-name">Bool</span>)
      ((<span class="type-name">AsList</span> nx xs)<span class="symbol">:</span><span class="type-name">List</span> n) ((<span class="type-name">AsList</span> ny ys)<span class="symbol">:</span><span class="type-name">List</span> n) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="comment">-- Orders Lists according to the order of their elements,
</span>  <span class="comment">-- in the same way a dictionary does.
</span>  <span class="comment">-- For example, this lets us sort Strings.
</span>  <span class="symbol">--</span>
  <span class="comment">-- More precisely, it returns True iff compareElements xs.i ys.i is true
</span>  <span class="comment">-- at the first location they differ.
</span>  <span class="symbol">--</span>
  <span class="comment">-- This function operates serially and short-circuits
</span>  <span class="comment">-- at the first difference.  One could also write this
</span>  <span class="comment">-- function as a parallel reduction, but it would be
</span>  <span class="comment">-- wasteful in the case where there is an early difference,
</span>  <span class="comment">-- because we can&#39;t short circuit.
</span>  iter <span class="symbol">\</span>i<span class="symbol">.</span>
    <span class="keyword">case</span> i <span class="symbol">==</span> min nx ny <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">Done</span> <span class="symbol">$</span> compareLengths nx ny
      <span class="type-name">False</span> <span class="symbol">-&gt;</span>
        xi <span class="symbol">=</span> xs<span class="symbol">.</span>(unsafe_from_ordinal _ i)
        yi <span class="symbol">=</span> ys<span class="symbol">.</span>(unsafe_from_ordinal _ i)
        <span class="keyword">case</span> compareElements xi yi <span class="keyword">of</span>
          <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">Done</span> <span class="type-name">True</span>
          <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> xi <span class="symbol">==</span> yi <span class="keyword">of</span>
            <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">Continue</span>
            <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Done</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> (<span class="type-name">List</span> n) <span class="keyword">given</span> {n} [<span class="type-name">Ord</span> n]
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> lexical_order (<span class="symbol">&gt;</span>) (<span class="symbol">&gt;</span>)
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> lexical_order (<span class="symbol">&lt;</span>) (<span class="symbol">&lt;</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>clip</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> clip {a} [<span class="type-name">Ord</span> a] ((low<span class="symbol">,</span>high)<span class="symbol">:</span>(a<span class="symbol">&amp;</span>a)) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  min high <span class="symbol">$</span> max low x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Trigonometric functions</h2>
<p>TODO: these should be with the other Elementary/Special Functions</p>
<h3>atan/atan2</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan_inner (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- From &quot;Computing accurate Horner form approximations to
</span>  <span class="comment">-- special functions in finite precision arithmetic&quot;
</span>  <span class="comment">-- https://arxiv.org/abs/1508.03211
</span>  <span class="comment">-- Only accurate in the range [-1, 1]
</span>  s <span class="symbol">=</span> x <span class="symbol">*</span> x
  r <span class="symbol">=</span> 0<span class="symbol">.</span>0027856871
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0158660002
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>042472221
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0749753043
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>106448799
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>142070308
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>199934542
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>333331466
  r <span class="symbol">=</span> r <span class="symbol">*</span> s
  r <span class="symbol">*</span> x <span class="symbol">+</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min_and_max {a} [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> a) <span class="symbol">=</span>
  select (x <span class="symbol">&lt;</span> y) (x<span class="symbol">,</span> y) (y<span class="symbol">,</span> x)  <span class="comment">-- get both with one comparison.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan2 (y<span class="symbol">:</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- Based off of the Tensorflow implementation at
</span>  <span class="comment">-- github.com/tensorflow/mlir-hlo/blob/master/lib/
</span>  <span class="comment">-- Dialect/mhlo/transforms/legalize_trigonometric_to_approximation.cc#L147
</span>  <span class="comment">-- With a fix to the nan propagation.
</span>  abs_x <span class="symbol">=</span> abs x
  abs_y <span class="symbol">=</span> abs y
  (min_abs_x_y<span class="symbol">,</span> max_abs_x_y) <span class="symbol">=</span> min_and_max abs_x abs_y
  a <span class="symbol">=</span> atan_inner (min_abs_x_y <span class="symbol">/</span> max_abs_x_y)
  a <span class="symbol">=</span> select (abs_x <span class="symbol">&lt;=</span> abs_y) ((pi <span class="symbol">/</span> 2<span class="symbol">.</span>0) <span class="symbol">-</span>a) a
  a <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) (pi <span class="symbol">-</span> a) a
  t <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) pi 0<span class="symbol">.</span>0
  a <span class="symbol">=</span> select (y <span class="symbol">==</span> 0<span class="symbol">.</span>0) t a
  t <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) (3<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">/</span> 4<span class="symbol">.</span>0) (pi <span class="symbol">/</span> 4<span class="symbol">.</span>0)
  a <span class="symbol">=</span> select (isinf x <span class="symbol">&amp;&amp;</span> isinf y) t a  <span class="comment">-- Handle infinite inputs.
</span>  a <span class="symbol">=</span> copysign a y
  select (either_is_nan x y) nan a  <span class="comment">-- Propagate NaNs.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> atan2 x 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Miscellaneous utilities</h2>
<p>TODO: all of these should be in some other section</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reflect {n} [<span class="type-name">Ix</span> n] (i<span class="command">:n</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  unsafe_from_ordinal n <span class="symbol">$</span> unsafe_nat_diff (size n) (ordinal i <span class="symbol">+</span> 1)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reverse {n a} (x<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>(reflect i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> wrap_periodic (n<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> n] (i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> n <span class="symbol">=</span> 
  unsafe_from_ordinal n  <span class="symbol">$</span> mod i (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> pad_to {n a} (m<span class="symbol">:</span><span class="type-name">Type</span>) [<span class="type-name">Ix</span> m] (x<span class="command">:a</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="keyword">for</span> i<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> n&#39; <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs<span class="symbol">.</span>(i&#39;<span class="symbol">@</span>_)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> idiv_ceil (x<span class="symbol">:</span><span class="type-name">Nat</span>) (y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> idiv x y <span class="symbol">+</span> b_to_n (rem x y <span class="symbol">/=</span> 0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intdiv2 (x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> %shr (nat_to_rep x) (1 <span class="symbol">::</span> <span class="type-name">NatRep</span>)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intpow2 (power<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> %shl (1 <span class="symbol">::</span> <span class="type-name">NatRep</span>) (nat_to_rep power)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_odd  (x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rem x 2 <span class="symbol">==</span> 1
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_even (x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rem x 2 <span class="symbol">==</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_power_<span class="keyword">of</span>_2 (x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="comment">-- A fast trick based on bitwise AND.
</span>  <span class="comment">-- This works on integer types larger than 8 bits.
</span>  <span class="comment">-- Note: The bitwise and operator (.&amp;.)
</span>  <span class="comment">-- is only defined for Byte, which is why
</span>  <span class="comment">-- we use %and here. TODO: Make (.&amp;.) polymorphic.
</span>  x&#39; <span class="symbol">=</span> nat_to_rep x
  <span class="keyword">if</span> x&#39; <span class="symbol">==</span> 0
    <span class="keyword">then</span> <span class="type-name">False</span>
    <span class="keyword">else</span> 0 <span class="symbol">==</span> %and x&#39; (%isub x&#39; (1<span class="symbol">::</span><span class="type-name">NatRep</span>))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> natlog2 (x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  tmp <span class="symbol">=</span> yield_state 0 <span class="symbol">\</span>ans<span class="symbol">.</span>
    cmp <span class="symbol">&lt;-</span> run_state 1
    while <span class="keyword">do</span>
      <span class="keyword">if</span> x <span class="symbol">&gt;=</span> (get cmp)
        <span class="keyword">then</span>
          ans <span class="symbol">:=</span> (get ans) <span class="symbol">+</span> 1
          cmp <span class="symbol">:=</span> rep_to_nat <span class="symbol">$</span> %shl (nat_to_rep <span class="symbol">$</span> get cmp) (1 <span class="symbol">::</span> <span class="type-name">NatRep</span>)
          <span class="type-name">True</span>
        <span class="keyword">else</span>
          <span class="type-name">False</span>
  unsafe_nat_diff tmp 1  <span class="comment">-- TODO: something less horrible
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> general_integer_power {a} (times<span class="command">:a</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) (one<span class="command">:a</span>) (base<span class="command">:a</span>) (power<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  <span class="comment">-- Implements exponentiation by squaring.
</span>  <span class="comment">-- This could be nicer if there were a way to explicitly
</span>  <span class="comment">-- specify which typelcass instance to use for Mul.
</span>  yield_state one <span class="symbol">\</span>ans<span class="symbol">.</span>
    pow <span class="symbol">&lt;-</span> with_state power
    z <span class="symbol">&lt;-</span> with_state base
    while <span class="keyword">do</span>
      <span class="keyword">if</span> get pow <span class="symbol">&gt;</span> 0
        <span class="keyword">then</span>
          <span class="keyword">if</span> is_odd (get pow)
            <span class="keyword">then</span> ans <span class="symbol">:=</span> times (get ans) (get z)
          z <span class="symbol">:=</span> times (get z) (get z)
          pow <span class="symbol">:=</span> intdiv2 (get pow)
          <span class="type-name">True</span>
        <span class="keyword">else</span>
          <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intpow {a} [<span class="type-name">Mul</span> a] (base<span class="command">:a</span>) (power<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  general_integer_power (<span class="symbol">*</span>) one base power
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_just {a} (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> a <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span> <span class="type-name">Just</span> x&#39; <span class="symbol">-&gt;</span> x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> any_sat {a n} (f<span class="command">:a</span> <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> any (map f xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> seq_maybes {n a} (xs <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Maybe</span> (n <span class="symbol">=&gt;</span> a) <span class="symbol">=</span>
  <span class="comment">-- is it possible to implement this safely? (i.e. without using partial
</span>  <span class="comment">-- functions)
</span>  <span class="keyword">case</span> any_sat is_nothing xs <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> map from_just xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linear_search {n a} [<span class="type-name">Eq</span> a] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (query<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> n <span class="symbol">=</span>
  yield_state <span class="type-name">Nothing</span> <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    <span class="keyword">case</span> xs<span class="symbol">.</span>i <span class="symbol">==</span> query <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> ref <span class="symbol">:=</span> <span class="type-name">Just</span> i
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> list_length {a} ((<span class="type-name">AsList</span> n _)<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- This is for efficiency (rather than using `&lt;&gt;` repeatedly)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want this for any monoid but this implementation won&#39;t work.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> concat {n a} (lists<span class="command">:n</span><span class="symbol">=&gt;</span>(<span class="type-name">List</span> a)) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  totalSize <span class="symbol">=</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> list_length lists<span class="symbol">.</span>i
  <span class="type-name">AsList</span> _ <span class="symbol">$</span> with_state 0 <span class="symbol">\</span>listIdx<span class="symbol">.</span>
    eltIdx <span class="symbol">&lt;-</span> with_state 0
    <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> totalSize)<span class="symbol">.</span>
      while <span class="keyword">do</span>
        continue <span class="symbol">=</span> get eltIdx <span class="symbol">&gt;=</span> list_length (lists<span class="symbol">.</span>((get listIdx)<span class="symbol">@</span>_))
        <span class="keyword">if</span> continue
          <span class="keyword">then</span>
            eltIdx <span class="symbol">:=</span> 0
            listIdx <span class="symbol">:=</span> get listIdx <span class="symbol">+</span> 1
          <span class="keyword">else</span> ()
        continue
      (<span class="type-name">AsList</span> _ xs) <span class="symbol">=</span> lists<span class="symbol">.</span>((get listIdx)<span class="symbol">@</span>_)
      eltIdxVal <span class="symbol">=</span> get eltIdx
      eltIdx <span class="symbol">:=</span> eltIdxVal <span class="symbol">+</span> 1
      xs<span class="symbol">.</span>(eltIdxVal<span class="symbol">@</span>_)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cat_maybes {a n} (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  (num_res<span class="symbol">,</span> res_inds) <span class="symbol">=</span> yield_state (0<span class="symbol">::</span><span class="type-name">Nat</span><span class="symbol">,</span> <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> <span class="type-name">Nothing</span>) <span class="symbol">\</span>ref<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">case</span> xs<span class="symbol">.</span>i <span class="keyword">of</span>
      <span class="type-name">Just</span> _ <span class="symbol">-&gt;</span>
        ix <span class="symbol">=</span> get <span class="symbol">$</span> fst_ref ref
        (snd_ref ref) <span class="symbol">!</span> (unsafe_from_ordinal _ ix) <span class="symbol">:=</span> <span class="type-name">Just</span> i
        fst_ref ref <span class="symbol">:=</span> ix <span class="symbol">+</span> 1
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> ()
  to_list <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> num_res)<span class="symbol">.</span>
    <span class="keyword">case</span> res_inds<span class="symbol">.</span>(unsafe_from_ordinal _ <span class="symbol">$</span> ordinal i) <span class="keyword">of</span>
      <span class="type-name">Just</span> j <span class="symbol">-&gt;</span> <span class="keyword">case</span> xs<span class="symbol">.</span>j <span class="keyword">of</span>
        <span class="type-name">Just</span> x <span class="symbol">-&gt;</span> x
        <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> todo <span class="comment">-- Impossible
</span>      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> todo <span class="comment">-- Impossible
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> filter {a n} [<span class="type-name">Ix</span> n] (condition<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  cat_maybes <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">if</span> condition xs<span class="symbol">.</span>i <span class="keyword">then</span> <span class="type-name">Just</span> xs<span class="symbol">.</span>i <span class="keyword">else</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> arg_filter {a n} [<span class="type-name">Ix</span> n] (condition<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">List</span> n <span class="symbol">=</span>
  cat_maybes <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">if</span> condition xs<span class="symbol">.</span>i <span class="keyword">then</span> <span class="type-name">Just</span> i <span class="keyword">else</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: use `ix_offset : [Ix n] -&gt; n -&gt; Int -&gt; Maybe n` instead
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> prev_ix {n} [<span class="type-name">Ix</span> n] (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> n <span class="symbol">=</span>
  <span class="keyword">case</span> i_to_n (n_to_i (ordinal i) <span class="symbol">-</span> 1) <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Just</span> i_prev <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> unsafe_from_ordinal n i_prev
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lines (source<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> <span class="type-name">List</span> <span class="type-name">String</span> <span class="symbol">=</span>
  (<span class="type-name">AsList</span> _ s) <span class="symbol">=</span> source
  (<span class="type-name">AsList</span> num_lines newline_ixs) <span class="symbol">=</span> cat_maybes <span class="keyword">for</span> i_char<span class="symbol">.</span>
    <span class="keyword">if</span> s<span class="symbol">.</span>i_char <span class="symbol">==</span> &#39;<span class="symbol">\</span>n&#39;
      <span class="keyword">then</span> <span class="type-name">Just</span> i_char
      <span class="keyword">else</span> <span class="type-name">Nothing</span>
  to_list <span class="keyword">for</span> i_line<span class="symbol">:</span>(<span class="type-name">Fin</span> num_lines)<span class="symbol">.</span>
    start <span class="symbol">=</span> <span class="keyword">case</span> prev_ix i_line <span class="keyword">of</span>
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> first_ix
      <span class="type-name">Just</span> i <span class="symbol">-&gt;</span> right_post newline_ixs<span class="symbol">.</span>i
    end <span class="symbol">=</span> left_post newline_ixs<span class="symbol">.</span>i_line
    post_slice s start end
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Probability</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- cdf should include 0.0 but not 1.0
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categorical_from_cdf {n} (cdf<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  r <span class="symbol">=</span> rand key
  <span class="keyword">case</span> search_sorted cdf r <span class="keyword">of</span>
    <span class="type-name">Just</span> i <span class="symbol">-&gt;</span> i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> normalize_pdf {d} (xs<span class="symbol">:</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span> xs <span class="symbol">/</span> sum xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cdf_<span class="keyword">for</span>_categorical {n} (logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  maxLogProb <span class="symbol">=</span> maximum logprobs
  cumsum_low <span class="symbol">$</span> normalize_pdf <span class="symbol">$</span> map exp <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">.</span> logprobs<span class="symbol">.</span>i <span class="symbol">-</span> maxLogProb
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categorical {n} (logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  categorical_from_cdf (cdf_<span class="keyword">for</span>_categorical logprobs) key
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- batch variant to share the work of forming the cumsum
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- (alternatively we could rely on hoisting of loop constants)
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categorical_batch {n m} [<span class="type-name">Ix</span> m] (logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>n <span class="symbol">=</span>
  cdf <span class="symbol">=</span> cdf_<span class="keyword">for</span>_categorical logprobs
  <span class="keyword">for</span> i<span class="symbol">.</span> categorical_from_cdf cdf <span class="symbol">$</span> ixkey key i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsumexp {n} (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  m <span class="symbol">+</span> (log <span class="symbol">$</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsoftmax {n} (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  lse <span class="symbol">=</span> logsumexp x
  <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">-</span> lse
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> softmax {n} (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  e <span class="symbol">=</span>  <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m)
  s <span class="symbol">=</span> sum e
  <span class="keyword">for</span> i<span class="symbol">.</span> e<span class="symbol">.</span>i <span class="symbol">/</span> s
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Polynomials</h2>
<p>TODO: Move this somewhere else</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> evalpoly {n v} [<span class="type-name">VSpace</span> v] (coefficients<span class="command">:n</span><span class="symbol">=&gt;</span>v) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> v <span class="symbol">=</span>
  <span class="comment">-- Evaluate a polynomial at x.  Same as Numpy&#39;s polyval.
</span>  fold zero <span class="symbol">\</span>i c<span class="symbol">.</span> coefficients<span class="symbol">.</span>i <span class="symbol">+</span> x <span class="symbol">.*</span> c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>TestMode</h2>
<p>TODO: move this to be in Testing Helpers</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dex_test_mode (()<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> unsafe_io <span class="keyword">do</span> check_env &quot;<span class="type-name">DEX</span>_<span class="type-name">TEST</span>_<span class="type-name">MODE</span>&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Exception effect</h2>
<p>TODO: move <code>error</code> and <code>todo</code> to here.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> catch {a eff} (f<span class="symbol">:</span><span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="type-name">Except</span><span class="symbol">|</span>eff} a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} <span class="type-name">Maybe</span> a <span class="symbol">=</span>
  ans <span class="symbol">=</span> %catchException f
  <span class="keyword">case</span> %sumToVariant ans <span class="keyword">of</span>
    {<span class="symbol">|</span>c<span class="symbol">=</span>()   <span class="symbol">|</span>} <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    {<span class="symbol">|</span>c<span class="symbol">|</span>c<span class="symbol">=</span>val<span class="symbol">|</span>} <span class="symbol">-&gt;</span> <span class="type-name">Just</span> val
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> throw {a} (_<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> {<span class="type-name">Except</span>} a <span class="symbol">=</span>
  %throwException a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> assert (b<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> {<span class="type-name">Except</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  <span class="keyword">if</span> not b <span class="keyword">then</span> throw ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Misc instances that require <code>error</code></h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> a (a<span class="symbol">|</span>b) <span class="keyword">given</span> {a b}
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="type-name">Left</span> x
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>  y <span class="symbol">-&gt;</span> <span class="type-name">Just</span> y
    <span class="type-name">Right</span> x <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>  x <span class="symbol">-&gt;</span> x
    <span class="type-name">Right</span> x <span class="symbol">-&gt;</span> error &quot;<span class="type-name">Can</span>&#39;t project <span class="type-name">Right</span> branch to <span class="type-name">Left</span> branch&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span> a (b<span class="symbol">|</span>a) <span class="keyword">given</span> {a b}
  inject&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="type-name">Right</span> x
  project&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>  x <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Right</span> y <span class="symbol">-&gt;</span> <span class="type-name">Just</span> y
  unsafe_project&#39; <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>  x <span class="symbol">-&gt;</span> error &quot;<span class="type-name">Can</span>&#39;t project <span class="type-name">Left</span> branch to <span class="type-name">Right</span> branch&quot;
    <span class="type-name">Right</span> x <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Testing Helpers</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- -- Reliably causes a segfault if pointers aren&#39;t initialized to zero.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- -- TODO: add this test when we cache modules
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- justSomeDataToTestCaching = toList for i:(Fin 100).
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   if ordinal i == 0
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--     then Left (toList [1,2,3])
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--     else Right 1
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Index set for tables</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> int_to_reversed_digits {a b} [<span class="type-name">Ix</span> a<span class="symbol">,</span> <span class="type-name">Ix</span> b] (k<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">:</span> a<span class="symbol">=&gt;</span>b <span class="symbol">=</span>
  base <span class="symbol">=</span> size b
  snd <span class="symbol">$</span> scan k <span class="symbol">\</span>_ cur_k<span class="symbol">.</span>
    next_k <span class="symbol">=</span> idiv cur_k base
    digit  <span class="symbol">=</span> mod  cur_k base
    (next_k<span class="symbol">,</span> unsafe_from_ordinal b digit)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reversed_digits_to_int {a b} [<span class="type-name">Ix</span> a<span class="symbol">,</span> <span class="type-name">Ix</span> b] (digits<span class="symbol">:</span> a<span class="symbol">=&gt;</span>b) <span class="symbol">:</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  base <span class="symbol">=</span> size b
  fst <span class="symbol">$</span> fold (0<span class="symbol">,</span> 1) <span class="symbol">\</span>j (cur_k<span class="symbol">,</span> cur_base)<span class="symbol">.</span>
    next_k <span class="symbol">=</span> cur_k <span class="symbol">+</span> ordinal digits<span class="symbol">.</span>j <span class="symbol">*</span> cur_base
    next_base <span class="symbol">=</span> cur_base <span class="symbol">*</span> base
    (next_k<span class="symbol">,</span> next_base)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span> (a<span class="symbol">=&gt;</span>b) <span class="keyword">given</span> {a b} [<span class="type-name">Ix</span> a<span class="symbol">,</span> <span class="type-name">Ix</span> b]
  <span class="comment">-- 0@a is the least significant digit,
</span>  <span class="comment">-- while (size a - 1)@a is the most significant digit.
</span>  size <span class="symbol">=</span> intpow (size b) (size a)
  ordinal             <span class="symbol">=</span> reversed_digits_to_int
  unsafe_from_ordinal <span class="symbol">=</span> int_to_reversed_digits
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span> (a<span class="symbol">=&gt;</span>b) <span class="keyword">given</span> {a b} [<span class="type-name">Ix</span> a<span class="symbol">,</span> <span class="type-name">NonEmpty</span> b]
  first_ix <span class="symbol">=</span> unsafe_from_ordinal _ 0
</div></div></div></body></html>